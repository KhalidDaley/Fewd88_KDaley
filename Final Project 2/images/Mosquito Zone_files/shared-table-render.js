var WKT=(function(){var d=/[-+]?([0-9]*\.[0-9]+|[0-9]+)([eE][-+]?[0-9]+)?/;var a=new RegExp("^"+d.source+"\\s"+d.source+"(\\s"+d.source+")?");function b(s){var f=s.split(";"),s=f.pop(),u=(f.shift()||"").split("=").pop();var j=0;function h(w){var i=s.substring(j).match(w);if(!i){return null}else{j+=i[0].length;return i[0]}}function t(i){if(i&&u.match(/\d+/)){i.crs={type:"name",properties:{name:"urn:ogc:def:crs:EPSG::"+u}}}return i}function l(){h(/^\s*/)}function e(){l();var z=0,x=[],i=[x],y=x,w;while(w=h(/^(\()/)||h(/^(\))/)||h(/^(\,)/)||h(a)){if(w=="("){i.push(y);y=[];i[i.length-1].push(y);z++}else{if(w==")"){if(y.length===0){return null}y=i.pop();if(!y){return null}z--;if(z===0){break}}else{if(w===","){y=[];i[i.length-1].push(y)}else{if(w.split(/\s/g).every(parseFloat)){Array.prototype.push.apply(y,w.split(/\s/g).map(parseFloat))}else{return null}}}}l()}if(z!==0){return null}return x}function q(){var w=[],i,x;while(x=h(a)||h(/^(\,)/)){if(x==","){w.push(i);i=[]}else{if(x.split(/\s/g).every(parseFloat)){if(!i){i=[]}Array.prototype.push.apply(i,x.split(/\s/g).map(parseFloat))}}l()}if(i){w.push(i)}else{return null}return w.length?w:null}function r(){if(!h(/^(point)/i)){return null}l();if(!h(/^(\()/)){return null}var i=q();if(!i){return null}l();if(!h(/^(\))/)){return null}return{type:"Point",coordinates:i[0]}}function v(){if(!h(/^(multipoint)/i)){return null}l();var i=e();if(!i){return null}l();return{type:"MultiPoint",coordinates:i}}function m(){if(!h(/^(multilinestring)/i)){return null}l();var i=e();if(!i){return null}l();return{type:"MultiLineString",coordinates:i}}function g(){if(!h(/^(linestring)/i)){return null}l();if(!h(/^(\()/)){return null}var i=q();if(!i){return null}if(!h(/^(\))/)){return null}return{type:"LineString",coordinates:i}}function p(){if(!h(/^(polygon)/i)){return null}l();var i=e();if(!i){return null}return{type:"Polygon",coordinates:i}}function k(){if(!h(/^(multipolygon)/i)){return null}l();var i=e();if(!i){return null}return{type:"MultiPolygon",coordinates:i}}function o(){var i=[],w;if(!h(/^(geometrycollection)/i)){return null}l();if(!h(/^(\()/)){return null}while(w=n()){i.push(w);l();h(/^(\,)/);l()}if(!h(/^(\))/)){return null}return{type:"GeometryCollection",geometries:i}}function n(){return r()||g()||p()||v()||m()||k()||o()}return t(n())}function c(e){if(e.type==="Feature"){e=e.geometry}function h(k){if(k.length===2){return k[0]+" "+k[1]}else{if(k.length===3){return k[0]+" "+k[1]+" "+k[2]}}}function f(k){return k.map(h).join(", ")}function g(k){return k.map(f).map(i).join(", ")}function j(k){return k.map(g).map(i).join(", ")}function i(k){return"("+k+")"}switch(e.type){case"Point":return"POINT ("+h(e.coordinates)+")";case"LineString":return"LINESTRING ("+f(e.coordinates)+")";case"Polygon":return"POLYGON ("+g(e.coordinates)+")";case"MultiPoint":return"MULTIPOINT ("+f(e.coordinates)+")";case"MultiPolygon":return"MULTIPOLYGON ("+j(e.coordinates)+")";case"MultiLineString":return"MULTILINESTRING ("+g(e.coordinates)+")";case"GeometryCollection":return"GEOMETRYCOLLECTION ("+e.geometries.map(c).join(", ")+")";default:throw new Error("stringify requires a valid GeoJSON Feature or geometry object as input")}}return{parse:b,stringify:c}})();blist.namespace.fetch("blist.data");(function(a){blist.data.Model=function(){var m=this;var i={blankRow:false,filterMinChars:3,pageSize:50,view:null};var n=0;var t={};var g={};var A={};var p=[];var s=[];var q=[];var f;this.options=function(C){if(C){var B=!a.isBlank(this.view);if(B){this.view.unbind(null,null,this)}a.extend(i,C);if(!a.isBlank(i.view)){this.view=i.view;this.view.bind("row_count_change",function(){w()},this).bind("clear_temporary",function(){z();v();w()},this).bind("query_change",function(){z();v();w()},this).bind("columns_changed",function(){z();f=null;a(p).trigger("columns_changed")},this).bind("row_change",function(D,E){_.each(a.makeArray(D),function(F){if(E){u(F)}else{if(F.expanded){m.view.trigger("row_change",[F.childRows])}}})},this);a(p).trigger("dataset_ready",[m])}if(B){f=null;z();v();w();a(p).trigger("columns_changed")}}return this};this.canRead=function(){return this.view&&this.view.hasRight(blist.rights.view.READ)};this.canWrite=function(){return this.view&&this.view.hasRight(blist.rights.view.WRITE)&&!this.view.isGrouped()};this.canAdd=function(){return this.view&&this.view.hasRight(blist.rights.view.ADD)&&!this.view.isGrouped()};this.canDelete=function(){return this.view&&this.view.hasRight(blist.rights.view.DELETE)&&!this.view.isGrouped()};this.useBlankRows=function(){return i.blankRow&&m.canAdd()&&m.canWrite()};this.addListener=function(B){var C=a.inArray(B,p);if(C==-1){p.push(B)}};this.removeListener=function(B){var C=a.inArray(B,p);if(C==-1){p=p.splice(C,1)}};this.loadRows=function(B,J,D,H){if(a.isBlank(this.view)){return false}if(this.usingBuckets()){if(_.isNull(this.currentBucket)){this.setRowBucket(B)}B+=this.currentBucket.start;J+=this.currentBucket.start}else{this.currentBucket={start:0}}var I=c(J,true);var C=J-I;var G=c(B,true);var E=B-G;var F=function(L){if(G!=I){for(var K=B;K<J;K++){if(!a.isBlank(t[K])){L.splice(K-B,0,t[K])}}}if(_.isFunction(D)){D(L)}};if(C==E){F([])}else{this.view.getRows(E,C-E,F,H,this.currentBucket.sortOrderForRequest)}return true};this.getAggregates=function(B){if(a.isBlank(this.view)){return false}this.view.getAggregates(B);return true};var b=function(){f=[[],[]];var C=[];var B=function(){if(C.length>0){f[1].push({renderTypeName:"fill",fillFor:C,id:"fill"+_.uniqueId()})}C=[]};_.each(m.view.visibleColumns,function(D){f[0].push(D);if(D.dataTypeName=="nested_table"){B();f[1].push(D)}else{C.push(D)}});B()};this.removeRows=function(D,B){D=a.makeArray(D);var C=_.map(D,function(E){return m.getByID(E)});if(!B){this.addUndoItem({type:"delete",rows:C})}_.each(C,function(E){m.unselectRow(E);if(E.expanded){m.expand(E,false)}});this.view.removeRows(D)};this.removeChildRows=function(C,F,B){var E=[];var D={};_.each(a.makeArray(C),function(G){var K=G.parent;var J=m.getRowValue(G,F);var I=m.getRowValue(K,F);for(var H=0;H<I.length;H++){if(J.id==I[H].id){J.origPosition=H;E.push({row:J,parentRow:K});D[K.id]=D[K.id]||[];D[K.id].push(J.id);break}}});if(!B){this.addUndoItem({type:"childDelete",rows:E,parentColumn:F})}_.each(D,function(H,G){m.view.removeRows(H,G,F.id)})};var x=function(C,B){if(!a.isBlank(B.parentColumn)){C=C.data[B.parentColumn.lookup]}return(C.invalid||{})[B.lookup]};var r=function(C,B){if(!a.isBlank(B.parentColumn)){C=C.data[B.parentColumn.lookup]}return C.data[B.lookup]};this.getRowValue=function(C,B){if(a.isBlank(C)){return undefined}if(x(C,B)){return null}return r(C,B)};this.getInvalidValue=function(C,B){if(a.isBlank(C)){return undefined}if(!x(C,B)){return null}return r(C,B)};this.isCellError=function(C,B){if(!a.isBlank(B.parentColumn)){C=C.data[B.parentColumn.lookup]}return C.error[B.lookup]};var u=function(C){if(C.expanded){m.expand(C,false,true);var B=C.childRows;delete C.childRows;m.expand(C,true,true);B=B.concat(C);m.view.trigger("row_change",[B])}else{delete C.childRows}};this.saveRowValue=function(I,M,D,L,K){if(a.isBlank(this.view)){return}var B=false;if(M.type=="blank"){delete M.type;if(this.view.newBackend&&this.view.rowIdentifierColumn==D){M.id=this.view.createRowWithPK(I)}else{M.id=this.view.createRow()}B=true;M=this.getByID(M.id);if(!K){this.addUndoItem({type:"create",rows:[M]})}}var C;var F;var G;if(!a.isBlank((D||{}).parentColumn)){G=D.parentColumn;F=m.getRowValue(M,G);C=M.parent;B=F.type=="blank";if(B){delete F.type;var J=this.index(M);if(C.type=="blank"){C=this.saveRowValue(null,C,null,true);K=true}F.id=this.view.createRow(null,C.id,G.id);F=m.getRowValue(M,G);M=this.get(J);if(!K){this.addUndoItem({type:"childCreate",rows:[M],parentColumn:G})}}}if(!K&&!B){var H;var E=false;if(!a.isBlank(D)){H=this.getRowValue(M,D);if(a.isBlank(H)){H=this.getInvalidValue(M,D);E=!a.isBlank(H)}}this.addUndoItem({type:"edit",column:D,row:M,value:H,invalid:E})}if(!a.isBlank(D)){if(a.isBlank(F)){this.view.setRowValue(I,M.id,D.id,!L);if(M.valid){this.view.saveRow(M.id)}}else{this.view.setRowValue(I,F.id,D.id,!L,C.id,G.id);this.view.saveRow(F.id,C.id,G.id)}}return M};var k=function(D){var C=[];_.each(m.view.columnsForType("nested_table",true),function(E){if(D.data[E.lookup] instanceof Array){_.each(D.data[E.lookup],function(G,F){G.origPosition=F;C.push({row:G,parentColumn:E})});delete D.data[E.lookup]}});var B=m.view.createRow(D);D=m.view.rowForID(B);_.each(C,function(E){o(E.row,D,E.parentColumn)});return D};var o=function(D,B,C){D.index=D.origPosition;m.view.createRow(D,B.id,C.id)};var d=function(C){if(C.length<1){return null}var E=C.pop();var G=null;switch(E.type){case"edit":var F=m.getRowValue(E.row,E.column);var B=false;if(a.isBlank(F)){F=m.getInvalidValue(E.row,E.column);B=!a.isBlank(F)}G={type:"edit",value:F,invalid:B,row:E.row,column:E.column};m.saveRowValue(E.value,E.row,E.column,!E.invalid,true);break;case"create":G={type:"delete",rows:E.rows};m.removeRows(_.pluck(E.rows,"id"),true);break;case"childCreate":G={type:"childDelete",rows:_.map(E.rows,function(H){return{parentRow:H.parent,row:y(H,E.parentColumn)}}),parentColumn:E.parentColumn};m.removeChildRows(E.rows,E.parentColumn,true);break;case"delete":G={type:"create",rows:[]};E.rows.reverse();_.each(E.rows,function(H){G.rows.push(k(H))});break;case"childDelete":var D=E.rows.slice();D.reverse();_.each(D,function(H){o(H.row,H.parentRow,E.parentColumn)});G={type:"childCreate",rows:_.map(E.rows,function(H){return l(H.parentRow,H.row.origPosition)}),parentColumn:E.parentColumn};break}return G};this.addUndoItem=function(B){q.length=0;s.push(B);this.undoRedoChange()};this.undo=function(){var B=d(s);if(B!==null){q.push(B);this.undoRedoChange()}};this.redo=function(){var B=d(q);if(B!==null){s.push(B);this.undoRedoChange()}};this.canUndo=function(){return s.length>0};this.canRedo=function(){return q.length>0};var z=function(){q.length=0;s.length=0;m.undoRedoChange()};var l=function(C,B){if(a.isBlank(C.childRows)){e(C)}return C.childRows[B]};var y=function(C,B){return C.data[B.lookup]};this.selectionChange=function(B){a(p).trigger("selection_change",[B])};this.undoRedoChange=function(){a(p).trigger("undo_redo_change")};this.index=function(B){if(a.isBlank(this.view)){return undefined}if(!a.isBlank(g[B.id])){return B.index}return B.index+c(B.index+1)-this.currentBucketStart()};this.get=function(B){if(a.isBlank(this.view)){return undefined}return t[B+this.currentBucketStart()]||this.view.rowForIndex(B-c(B,true)+this.currentBucketStart())};this.getByID=function(B){if(a.isBlank(this.view)){return undefined}return g[B]||this.view.rowForID(B)};this.columns=function(){if(a.isBlank(this.view)){return null}if(a.isBlank(f)){b()}return f};this.columnForID=function(C){if(a.isBlank(this.view)){return null}var B=this.view.columnForID(C);if(a.isBlank(B)){_.each(this.view.columnsForType("nested_table"),function(D){B=B||D.childColumnForID(C)})}return B};this.length=function(B){if(_.isUndefined(B)){B=true}if(B&&this.usingBuckets()&&!_.isNull(this.currentBucket)){return Math.min(this.view.bucketSize,this.dataLength()-this.currentBucketStart()+n)}else{return this.dataLength()+n}};this.dataLength=function(){var B=(this.view||{}).totalRows();return a.isBlank(B)?-1:B};this.level=function(B){if(a.isBlank(this.view)||a.isBlank(f)){return null}return f[B]};this.nextInLevel=function(G,D){var F=G;var E=0;if(!a.isBlank(t[F])){E=t[F].level||0}if(D){while(--F>=0){if(((this.get(F)||{}).level||0)==E){return F}}}else{var B=this.length();while(++F<B){var C=this.get(F);if(a.isBlank(C)||(C.level||0)==E){return F}}}return null};this.hasSelectedRows=function(){return a.subKeyDefined(this.view,"highlightTypes.select")&&!_.isEmpty(this.view.highlightTypes.select)};this.toggleSelectRow=function(B){if(!a.subKeyDefined(this.view,"highlightTypes.select."+B.id)){this.selectRow(B)}else{this.unselectRow(B)}};this.selectRow=function(B){if(B.type=="blank"){return}this.view.highlightRows(B,"select");a(p).trigger("display_row",[{row:B}])};this.unselectRow=function(B){this.view.unhighlightRows(B,"select");a(p).trigger("display_row",[{row:null}])};this.unselectAllRows=function(){this.view.highlightRows(null,"select");a(p).trigger("display_row",[{row:null}])};this.selectRowsTo=function(H){if(!this.hasSelectedRows()){return this.selectRow(H)}var B=_.min(_.map(this.view.highlightTypes.select,function(I){return m.index(I)}));var F=this.index(H);var E=F;if(F<B){E=B;B=F}var G=[];for(var D=B;D<=E;D++){var C=this.get(D);if(!a.isBlank(C)&&C.type!="blank"){G.push(C)}}this.view.highlightRows(G,"select")};var e=function(J){if(J.childRows){return J.childRows}var F=m.columns()[J.level||0];var G=J.childRows=[];var I=(J.level||0)+1;for(var E=0;E<F.length;E++){var B=F[E];if(a.isBlank(B.visibleChildColumns)){continue}var H=J.data[B.lookup];if(a.isBlank(H)&&!m.useBlankRows()){continue}H=H||[];var K=(H.length||0)+(m.useBlankRows()?1:0);for(var D=0;D<K;D++){var C=G[D];if(!C){C=G[D]={data:{}};C.id="t"+_.uniqueId();C.level=I;C.parent=J;C.index=-1}C.data[B.lookup]=H[D];if(!C.data[B.lookup]){C.data[B.lookup]={data:{},invalid:{},changed:{},error:{}};C.data[B.lookup].type="blank"}}}if(G.length){G[G.length-1].groupLast=true}return G};this.expand=function(F,C,B){if(F===undefined){return}if(C===undefined){C=!F.expanded}if(C===F.expanded){return}if(C){var D=e(F);a.addItemsToObject(t,D,this.index(F)+1);_.each(D,function(G){g[G.id]=G});n+=D.length;A[F.id]=true}else{if(F.childRows&&F.childRows.length){a.removeItemsFromObject(t,this.index(F)+1,F.childRows.length);n-=F.childRows.length;_.each(F.childRows,function(G){delete g[G.id]})}delete A[F.id]}F.expanded=C;if(!B){var E=[F];if(!F.expanded&&!a.isBlank(F.childRows)){E=E.concat(F.childRows)}this.view.trigger("row_change",[E])}};this.currentBucket=null;this.usingBuckets=function(){return this.view.usingBuckets()};this.getLastIndex=function(){if(this.usingBuckets()){var B=this.view.getRowBucket(this.dataLength());return this.dataLength()-B.start}else{return this.length()}};this.setRowBucket=function(E,C){if(!_.isUndefined(C)){this.setSortOrder(C)}var B=(this.currentBucket||{}).sortOrderForRequest;var D=function(){if(_.isFunction(_.get(console,"error"))){console.error("setBucket called with invalid bucket: {0}".format(E))}};if(_.isPlainObject(E)){if(_.has(E,"start")&&_.has(E,"finish")){this.currentBucket=E}else{D()}}else{if(_.isNumber(E)){this.currentBucket=this.view.getRowBucket(E)}else{D()}}this.currentBucket.sortOrderForRequest=B;return this.currentBucket};this.setSortOrder=function(B){if(!_.isNull(this.currentBucket)){this.currentBucket.sortOrderForRequest=B}};this.currentBucketStart=function(){if(_.isNull(this.currentBucket)){return 0}return this.currentBucket.start};this.currentBucketIndexOrUndefined=function(){if(_.isNull(this.currentBucket)){return}return this.view.bucketIndex(this.currentBucket.start)};this.totalBuckets=function(){return this.view.totalBuckets()};this.inFirstBucket=function(){if(_.isNull(this.currentBucket)){return}return this.currentBucket.start===0};this.inLastBucket=function(){if(_.isNull(this.currentBucket)){return}return this.currentBucket.finish>=this.dataLength()};var w=function(){j();h();if(m.useBlankRows()){var B={invalid:{},changed:{},error:{},data:{},metadata:{}};B.type="blank";B.id="blank";B.index=m.getLastIndex();t[m.length(false)]=B;g[B.id]=B;n++}m.unselectAllRows();a(p).trigger("rows_changed")};var c=function(B,E){var D=0;if(a.isBlank(B)){B=m.dataLength()}var C=0;if(B>n){_.each(t,function(G,F){if(F<B){D++}});C=B;if(!E){B+=D}}while(C<B){if(!a.isBlank(t[C])){D++;if(!E){B++}}C++}return D};var j=function(){var B=n>0;t={};g={};n=0;return B};var v=function(){_.each(_.keys(A),function(B){m.expand(m.getByID(B),false,true)})};var h=function(){var B=[];_.each(A,function(C,F){var E=m.getByID(F);if(a.isBlank(E)){B.push(F);return}var D=e(E);a.addItemsToObject(t,D,m.index(E)+1);_.each(D,function(G){g[G.id]=G});n+=D.length;E.expanded=true});_.each(B,function(C){delete A[C]});return !_.isEmpty(A)};z()};a.fn.extend({blistModel:function(c){if(c){this.each(function(){var d=a(this).data("blistModel");if(d){d.removeListener(this)}});this.data("blistModel",c);this.each(function(){c.addListener(this)});return c}var b=this.data("blistModel");if(b){return b}return this.blistModel(new blist.data.Model())}})})(jQuery);(function(h){var f=100;var a=100;var e=100;var d=10;var m=1;var l=function(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};var i=false;i=i&&window.console;if(window.console&&!window.console.time){var b={};window.console.time=function(n){b[n]=new Date().getTime()};window.console.timeEnd=function(o){var n=new Date().getTime()-b[o];h.debug("[Time] "+o+": "+n);delete b[o]}}var c=i?function(n){console.time(n)}:function(){};var g=i?function(n){console.timeEnd(n)}:function(){};var j=function(bI){var cA;var aJ=false;var ag=this.id;if(!ag){ag=m++;ag="blist-t"+ag;this.id=ag}var af=h(this);var bu=function(){return Math.ceil(Math.log(cA.length()||1)*Math.LOG10E)};var ck=function(cN){c("sort.configure");var cO=true;if(!h.isBlank(cN.sortAscending)){cO=!cN.sortAscending}g("sort.configure");c("sort.sort");af.trigger("column_sort",[cN,cO]);g("sort.sort")};var cw=function(){h(".sort.active",L).removeClass("sort-asc").addClass("sort-desc").attr("title",h.t("controls.grid.sort_ascending")).removeClass("active").closest(".blist-th").removeClass("sorted");for(var cQ=0;cQ<bi.length;cQ++){var cP=bi[cQ];if(cP.dom&&!h.isBlank(cP.sortAscending)){var cN=!cP.sortAscending;var cO="sort-"+(cN?"asc":"desc");var cR="sort-"+(cN?"desc":"asc");var cS=h.t("controls.grid.sort_"+(cN?"ascending":"descending"));h(".sort",cP.dom).removeClass(cO).addClass(cR).attr("title",cS).addClass("active").closest(".blist-th").addClass("sorted")}}};var b0=function(){h(".filter.active",L).removeClass("active").closest(".blist-th").removeClass("filtered");_.each(bi,function(cN){if(!h.isBlank(cN.currentFilter)){h(".filter",cN.dom).addClass("active").closest(".blist-th").addClass("filtered")}})};var bL=function(cN){return cA.columnForID(cN.getAttribute("colId"))};var R=function(cN){var cO=cN.parentNode;if(!cO){return null}var cP=cO.id.substring(ag.length+2);return cA.getByID(cP)};var cM=function(cN){var cP=cN.className.indexOf(ag+"-c");if(cP==-1){return null}var cO=cN.className.indexOf(" ",cP);if(cO==-1){cO=cN.className.length}var cQ=cN.className.slice(cP+ag.length+2,cO);if(cQ=="rowHandleCol"){return b6}else{if(cQ=="rowNumberCol"){return bx}}return cA.columnForID(cQ)};var ah=function(cN){if(cN.renderTypeName=="opener"){return aS+al}else{if(cN.mcol){cN=cN.mcol}}return(cN.width||parseFloat(bD(cN).width))+al};var cI=function(cN,cO){if(!cf){return}cf.setColumnSelection(cN,cO);if(cO){cA.unselectAllRows()}bP();bv()};var aY=function(cP){if(!cf){return}if(cf.lastSelectedColumn===null){cI(cP,true);return}var cO=false;var cN=cf.lastSelectedColumn.id;_.each(bi,function(cQ){if(cQ.id==cP.id||cQ.id==cN){cO=!cO;if(!cO){return false}}if(cO){cf.setColumnSelection(cQ,true)}});cI(cP,true)};var bR=function(cN){if(!cf){return}cf.clearColumnSelection();cI(cN,true)};var bP=function(){if(!cf){return}for(var cO=0;cO<bi.length;cO++){var cP=bi[cO];var cN=L.find("."+ag+"-c"+cP.id);var cQ=r(cP);if(cf.isColumnSelected(cP)){if(!cN.is(".blist-select-col")){var cR=cN.addClass("blist-select-col").offset().left;N.append('<div class="col-select-holder blist-table-util '+cQ+'"/>').find(".col-select-holder."+cQ).css("left",cR-L.offset().left+cu).removeClass("blist-table-util")}}else{if(cN.is(".blist-select-col")){cN.removeClass("blist-select-col");N.find(".col-select-holder."+cQ).remove()}}}};var cf;var aE;var aA=function(){var cN=[];for(var cP in bb){var cO=bb[cP];cN.push(cO)}return cN=_.sortBy(cN,function(cQ){return cA.index(cQ)})};var cy=function(cO){if(cO.row!==undefined){for(var cN=cO.row.firstChild;cN;cN=cN.nextSibling){if(cN._sel){h(cN).removeClass("blist-cell-selected");cN._sel=false}}}delete cO.selected};var ch=function(cP,cN){cP.selected=true;for(var cQ=0,cO=cP.row.firstChild;cO;cO=cO.nextSibling,cQ++){if(cN[cQ]){if(!cO.selected){h(cO).addClass("blist-cell-selected");cO._sel=true}}else{if(cO._sel){h(cO).removeClass("blist-cell-selected");cO._sel=false}}}};var J=function(cN){bn[0].focus()};var bv=function(){if(!cf){return}if(cf.isActive()){var cQ=cA.get(cf.getActiveY());if(cQ!==undefined){var cP=bb[cQ.id];if(cP){var cN=h(cP.row).children().slice(cf.getActiveX(),cf.getActiveXEnd())}}if(cN){aE=cN}else{aE=null}}var cO=aA();cf.processSelection(cO,ch,cy);cf.initCopy()};var at;var aM;var aN=function(cN){if(at){at.css("top",-10000);at.css("left",-10000)}if(!cN){C(true,cp)}};var A;var cl=function(){if(cg[bQ]||!cf.isActive()){aN();return}if(cg[cp]){aN(true);return}var cP;if(aE&&aE.length>0){cP=cM(aE[0]);var cT=cP?cP.renderType:null;if(cT&&cT.isInlineEdit){if(bk(aE[0],cp)){return}}}if(!at){at=h('<div class="blist-table-active-container blist-table-util"></div>');bc.append(at)}else{if(at[0].parentNode==null||at[0].parentNode.nodeType==11){bc.append(at)}}var cW=cA.get(cf.getActiveY());if(cW!==undefined&&cW.expanded){at.addClass("blist-tr-open")}else{at.removeClass("blist-tr-open")}if(!aE){at.empty();at.height(a9-(at.outerHeight()-at.height()));var cN=0;for(var cQ=cf.getActiveX(),cV=cf.getActiveXEnd();cQ<cV;cQ++){cN+=ah(aL[0][cQ])}at.width(cN-(at.outerWidth()-at.width()));var cU=cf.getActiveY();at.css("top",cU*aU-bc.position().top);var cO=cu;for(var cR=0;cR<cf.getActiveX();cR++){cO+=ah(aL[0][cR])}at.css("left",cO);return}if(!cP){cP=cM(aE[0])}var cS=aE.clone();cS.width("auto").height("auto");at.width("auto").height("auto");if(aE!=A&&(h.isBlank(A)||aE.index(A)<0)){at.empty();at.append(cS);A=aE}if(bI.cellComments&&!!cP&&!!cW&&h.isBlank(cP.parentColumn)&&!cA.view.isGrouped()){if(!aM){aM=h('<a href="#Comments" class="commentLink feed" title="'+h.t("controls.grid.view_cell_comments")+'"><span class="icon"></span></a>')}aM.data("rowId",cW.id);aM.data("tableColumnId",cP.tableColumnId);at.append(aM)}else{aM=null}at.toggleClass("comments-active",aE.hasClass("comments-active"));bt(at,cS,aE,aM);Q(at,aE);at.removeClass("blist-table-util")};var O=function(){if(cf&&cf.clearAll()){aE=null;bP();bv();cl();N.find(".col-select-holder").remove()}};var D=function(cO){var cT=R(cO);if(!cT){return null}var cQ=cT.level||0;var cP=aL[cQ];var cN;var cR;var cS;for(cN=0,cR=cO.parentNode.firstChild;cR;cR=cR.nextSibling){cS=cP[cN];if(!cS){break}if(cR==cO){break}if(cS.skippable&&h(cR).hasClass("blist-skip")){cN+=cS.skipCount}cN++}if(cS===undefined){return null}return{x:cN,y:cA.index(cT)}};var cj=function(cN,cQ){var cP=cA.get(cQ);if(cP!==undefined){var cO=bb[cP.id];if(cO){return h(cO.row).children().eq(cN)}}return null};var ct=function(cO,cQ,cR){var cP=D(cO);if(!cP){O();return false}if(cQ){var cN=h(cQ.target);if(cN.closest(".blist-table-locked").length>0||(!cR&&cN.closest(".blist-tdh")>0)||cN.is(".blist-table-expander")){return false}}cA.unselectAllRows();if(cN&&cN.is("a")&&!cR){O();return true}return bA(cP,cQ,cR)};var bA=function(c2,cN,cY,cP){if(!cf.goTo(c2.x,c2.y,cN,cY,cP)){return false}c2.x=cf.getActiveX();c2.y=cf.getActiveY();if(cN){var cQ=bs[0].scrollTop;var cU=cQ/aU;var c3=cU+cB-2;var cO=cQ;if(c2.y>c3){cQ=Math.ceil((c2.y-(cB-2))*aU)}if(c2.y<cU){cQ=Math.floor(c2.y*aU)}if(cQ!=cO){bs.scrollTop(cQ)}var cS=bs.scrollLeft();var cX=bs.width();if(bs[0].scrollHeight>bs[0].clientHeight){cX-=bF}var cR=cS+cX;var c1=cA.get(c2.y);var cZ=aL[c1!==undefined?(c1.level||0):0];var cT=cu;for(var cW=0;cW<c2.x;cW++){cT+=ah(cZ[cW])}var c0=cT;for(var cV=0;cV<cf.getActiveWidth();cV++){c0+=ah(cZ[c2.x+cV])}if(c0>cR){bs.scrollLeft(c0-cX)}if(cT-cu<cS){bs.scrollLeft(cT-cu)}}ak();bv();return true};var S={};var cg={};var bQ="edit";var ci="expand";var cp="select";var cG=function(){return bI.editEnabled&&cA.canWrite()};var bk=function(cT,cQ,cN){if(!cQ){cQ=bQ}if(cg[cQ]){return false}if(!cG()){if(cQ==bQ){h(cT).trigger("attempted_edit")}return false}var cV=R(cT);var cO=cM(cT);if(!cO||cO.id=="rowHandleCol"||cO.id=="rowNumberCol"||cO.isLinked()||!cV){return false}var cS=cA.getRowValue(cV,cO);if(!cS){cS=cA.getInvalidValue(cV,cO)}var cR=h('<div class="blist-table-edit-container mode-'+cQ+' blist-table-util"></div>');bs.append(cR);var cP=cA.columnForID(cO.id);if(h.isBlank(cP.renderType.interfaceType)){return}var cU=cR.blistEditor({type:cP.renderType,row:cV,value:cS,newValue:cN,colLookup:cP.lookup,modelView:cA.view,format:cP.format,customProperties:{dropDownList:cP.dropDownList,baseUrl:cP.baseUrl()}});cR.data("realColumn",cP);ba(cT,cR,cQ);if(cQ==ci){cR.bind("editor-change",function(){be(cT,cR,cQ,cp)})}return true};var be=function(cO,cP,cN,cQ){cP.unbind();cP.removeClass("mode-"+cN);cg[cN]=false;delete S[cN];O();if(cg[cp]){C(true,cp)}if(cg[bQ]){C(true,bQ)}ct(cO);z();cP.addClass("mode-"+cQ);ba(cO,cP,cQ)};var ba=function(cN,cO,cU){var cP=cO.blistEditor();cO.bind("edit_end",function(cW,cV,cX){bm(cW,cV,cX,cU)});if(cU==cp){cO.keydown(bd).keypress(G)}var cT=cP.$editor();cg[cU]=true;S[cU]=cO;if(cU==bQ){aN()}var cR=D(cN);var cQ=function(){if(cR){var cV=cj(cR.x,cR.y);if(cV){cP.adjustSize(cV[0].offsetWidth+1,cV[0].offsetHeight+1,bs.width()*0.8,bs.height()*0.8);Q(cO,cV)}}};var cS=function(){cQ();cO.bind("resize",function(){cQ()});cT.closest(".blist-table-edit-container").removeClass("blist-table-util").addClass("shown");if(cU!=ci){cP.focus()}};cP.initComplete(cS)};var C=function(cO,cP){if(!cP){cP=bQ}if(!cg[cP]){return}if(cP==bQ){J()}delete cg[cP];var cS=S[cP];if(!cS){return}var cQ=cS.blistEditor();cQ.finishEdit();var cR=cQ.originalValue;var cT=cQ.currentValue();var cV=cQ.row;var cU=cQ.isValid();var cN=cS.data("realColumn");delete S[cP];if(cO&&(!h.compareValues(cR,cT)||cA.isCellError(cV,cN))){cA.saveRowValue(cT,cV,cN,cU)}_.defer(function(){cS.remove()})};var bm=function(cO,cP,cN,cQ){C(cP,cQ);cN=cN||{};if(cN.type=="keydown"){if(cQ==bQ&&(cN.keyCode==27||cN.keyCode==113)){X=true;cl()}else{bd(cN)}}if(!cg[bQ]&&(cN.type!="mousedown"||bB(cN.target))){J()}else{cf.deactivate()}};var ca;var bM;var z=function(){if(ca){ca.style.top="-10000px";ca.style.left="-10000px";bM=false}};var ak=function(){if(B){clearTimeout(B);B=null}C(true,ci);z()};var bq=function(cO,cN){if(by){b1(cN)}by=cO;if(cO){h(cO).addClass("blist-hot");if(bI.cellExpandEnabled){B=setTimeout(cv,f)}}};var cv=function(){if(bI.noExpand){return}if(!B){return}B=null;var cQ=cM(by);var cP=cQ?cQ.renderType:null;if(cP&&cP.isInlineEdit){if(bk(by,ci)){return}}if(!ca){ca=document.createElement("div");var cU=h(ca);cU.addClass("blist-table-expander");cU.addClass("blist-table-util")}else{z();cU=h(ca)}if(ca.parentNode==null||ca.parentNode.nodeType==11){bc.append(cU)}var cS=h(by);var cN=cS.clone();cN.width("auto").height("auto");cU.width("auto").height("auto");cU.empty();cU.append(cN);var cR=cS.outerWidth();var cO=cS.outerHeight();if(cN.outerWidth()<=cR+2&&cN.outerHeight()<=cO+2){z();return}var cT=bt(cU,cN,cS,null,true);cT=h.extend(cT,Q(cU,cS,true,cT));cU.removeClass("blist-table-util");bM=true;cU.animate(cT,a,null,function(){if(!bM){z()}})};var Q=function(c0,cR,cT,cY){var cW=c0.parent();var cQ=cR.offset().left-cW.offset().left+cW.scrollLeft();var cV=cR.offset().top-cW.offset().top-1+cW.scrollTop();var cS={top:cV,left:cQ};var c4;var cX;var cO=cY?cY.width:c0.outerWidth();var c1=bs.width();if(bs[0].scrollHeight>bs[0].clientHeight){c1-=bF}var c2=bs.scrollLeft();var c3=cR.outerWidth();if(cQ+cO>c2+c1&&cQ+c3-c2>c2+c1-cQ){c4=cQ+c3-c2;cQ-=Math.min(c4,cO)-c3}else{c4=c2+c1-cQ}var cU=cY?cY.height:c0.outerHeight();var cP=bs.height();if(aR.is(":visible")){cP-=aR.outerHeight()-1}if(a8.is(":visible")){cP-=a8.outerHeight()-1}if(bs[0].scrollWidth>bs[0].clientWidth){cP-=bF}var cN=cW.scrollTop()+(bs.offset().top-cW.offset().top);var cZ=cR.outerHeight();if(cV+cU>cN+cP&&cV+cZ-cN>cN+cP-cV){cX=cV+cZ-cN;cV-=Math.min(cX,cU)-cZ}else{cX=cN+cP-cV}if(!cT){cS={top:cV,left:cQ}}c0.css("top",cS.top+"px");c0.css("left",cS.left+"px");c0.css("max-width",c4+"px");c0.css("max-height",cX+"px");return({left:cQ,top:cV})};var bt=function(c1,cT,cX,cS,cP){cT.eq(0).addClass("blist-first");cT.eq(cT.length-1).addClass("blist-last");c1.css("max-width","").css("max-height","");var c0={width:c1.outerWidth(),height:c1.outerHeight()};var c2=0;var cZ=0;var cW=[];_.each(h.makeArray(cX).concat(h.makeArray(cS)),function(c6){var c7=h(c6);var c5=c7.outerWidth();c2+=c5;cW.push(c5);cZ=Math.max(cZ,c7.outerHeight())});c2+=1;cZ+=1;if(c0.width<c2){c0.width=c2}if(c0.height<cZ){c0.height=cZ}var c3=bs.width();if(bs[0].scrollHeight>bs[0].clientHeight){c3-=bF}var c4=bs.offset().left;c3=Math.max(c3-(cX.eq(0).offset().left-c4),(cX.eq(-1).offset().left-c4)+cX.eq(-1).outerWidth(true));c3=Math.floor(c3*0.8);if(c0.width>c3){c1.width(c3);c0.width=c3;c0.height=c1.outerHeight()}var cY=bs.height();if(bs[0].scrollWidth>bs[0].clientWidth){cY-=bF}var cQ=bs.offset().top;cY=Math.max(cY-(cX.eq(0).offset().top-cQ),(cX.eq(-1).offset().top-cQ)+cX.eq(-1).outerHeight(true));cY=Math.floor(cY*0.9);if(c0.height>cY){c0.height=cY}var cV=c1.outerWidth()-c1.width();var cU=c1.outerHeight()-c1.height();c0.width-=cV;c0.height-=cU;var cN=c0.width;if(!h.isBlank(cS)){cS.each(function(){var c5=h(this);cN-=c5.outerWidth()})}var cR=false;var cO=0;cT.each(function(c9){var c7=cW.shift();var da=h(this);var c6=da.outerWidth();var c8=c6-da.width();if(c9==0&&cT.length>1){c8+=cV/2}if(!cR&&da.outerHeight()>c0.height){cN-=bF;cR=true}if(c6>c7){c8--;cO++}da.width(Math.min(Math.max(c7,c6),cN)-c8);cN-=da.outerWidth();if(c0.height>da.outerHeight()){var c5=da.outerHeight()-da.height();da.height(c0.height-c5)}});c0.width+=cO;if(!cP){c2=c0.width;cZ=c0.height}c1.width(c2);c1.height(cZ);return c0};var by;var cF;var B;var aI;var aC;var y=false;var ad;var aB;var a4;var u;var bY;var V;var bS=function(cO,cN){var cP;try{cP=h(cO.type=="mouseout"?cO.relatedTarget:cO.target)}catch(cQ){cP=h(cO.target)}if(!cP){return null}if(!cP.is(cN)){cP=cP.closest(cN);if(!cP.length){return null}}return cP[0]};var bg=function(cO){var cN=bS(cO,".blist-td, .blist-table-expander, .blist-table-active-container, .blist-table-edit-container");if(!cN){return null}var cP=h(cN);if(cP.is(".blist-tdfill, .blist-opener-space")){return null}if(aE&&((at&&(cP[0]==at[0]||cP.parent()[0]==at[0]))||cP.closest(".blist-table-edit-container.mode-"+bQ).length>0||cP.closest(".blist-table-edit-container.mode-"+cp).length>0)){return aE[0]}if(cP.hasClass("blist-tdh")){while(!cP.hasClass("blist-opener")){cP=h(cN=cN.previousSibling)}return cN}if(cN==ca||cN.parentNode==ca||cP.closest(".blist-table-edit-container.mode-"+ci).length>0){return by}return cN};var ar=function(cN){if(aC==4&&y||E){return false}var cO=bS(cN,".blist-tr, .blist-table-header");if(!cO){return false}var cU=cN.clientX;var cQ,cT;var cR=false;var cS=h(".blist-th:not(.blist-table-ghost), .blist-tdh",cO);cS.each(function(c2){var c3=h(this);var cZ=c3.offset().left;if(cZ>cU){return false}var cW=c3.outerWidth();var c5=cZ+cW;var c0=c3.is(".blist-opener, .blist-table-row-handle, .blist-table-ghost, .blist-column-adder");var c1=!c0&&!c3.is(".nested_table")&&!(bI.disableLastColumnResize&&(c2==(cS.length-1)));if(c1&&cU>=c5-bI.resizeHandleAdjust&&cU<c5+bI.resizeHandleAdjust){cQ=c3[0];cT=2;a4=cZ;cR=c3.is(".blist-th, .blist-tr-open .blist-tdh");return false}if(cU>=cZ&&cU<c5){cQ=c3[0];var cY=c3.find(".dragHandle");if(cY.length<1){return false}var cX=cY.offset().left;var c4=cX+cY.outerWidth();if(cU>=cX&&cU<c4){cT=4}else{cT=c0?3:1}cR=c3.is(".blist-th, .blist-tr-open .blist-tdh");return false}});if(cQ){if(cQ!=aI||cT!=aC){aI=cQ;aC=cT;var cP=h(aI);var cV=cP.hasClass("blist-tdh");if(aC==2){cm.css("cursor","col-resize");if(cV){cP.css("cursor","col-resize")}}else{cm.css("cursor","default");if(cV){cP.css("cursor","default")}}}return cR}return false};var v=function(cP,cQ){var cO=cP.clientX-a4-al;if(cO<d){cO=d}var cN=bL(aI);if(cN.hasOwnProperty("minWidth")&&cO<cN.minWidth){cO=cN.minWidth}if(cN.hasOwnProperty("percentWidth")){I[0]-=cN.percentWidth;delete cN.percentWidth;cq[0]=h.grep(cq[0],function(cS,cR){return cS.id==cN.id},true);if(cN.minWidth){bO[0]-=cN.minWidth}}cN.update({width:cO});cN.view._markTemporary(!cN.view.isDefault()||!cN.view.isPublished());cC(h(cN.dom),true);af.trigger("column_resized",[cN,cQ]);bP()};var bT=function(cN){h("#"+ag+"-r"+cN).addClass("blist-hot-row");h("#"+ag+"-l"+cN).addClass("blist-hot-row");cA.view.highlightRows({id:cN})};var x=function(cN){h("#"+ag+"-r"+cN).removeClass("blist-hot-row");h("#"+ag+"-l"+cN).removeClass("blist-hot-row");if(cN==cF){cF=null}cA.view.unhighlightRows({id:cN})};var b7=function(cO){if(y){if(aC==2){v(cO);return}else{if(aC==4){return}}}if(aB){if(u&&Math.abs(cO.clientX-aB.x)>3||Math.abs(cO.clientY-aB.y>3)){u=null;bY=null}if(V&&!u){if(!cf.selectionInit(D(V))){ct(V,cO)}var cQ=bg(cO);if(cQ&&h(cQ).closest(".blist-table-edit-container").length<=0){ct(cQ,cO,true)}}return}if(ar(cO)){if(by){b1(cO)}}else{if(aI){aI=null;cm.css("cursor","auto")}}cQ=bg(cO);if(cQ==by||(aE&&aE.index(cQ)>=0)||h(cQ).closest(".blist-table-edit-container").length>0){return}var cP=h(cQ).closest(".blist-tr");var cN=cP.length>0?(cP.attr("id")||"").substring(ag.length+2):null;if(!E&&cN!=cF){if(cF){x(cF)}if(cN){bT(cN)}cF=cN}bq(cQ,cO)};var b1=function(cO){if(h(cO.relatedTarget).closest(".columnHeaderMenu, .rowMenu").length>0){return}if(by){var cQ=bg(cO);if(cQ==by){return}if(cF){var cP=h(cQ).closest(".blist-tr");var cN=cP.length>0?cP.attr("id").substring(ag.length+2):null;if(cN!=cF){x(cF)}}h(by).removeClass("blist-hot");by=null;ak()}};var co=function(cS,cP){var cO=bg(cS);if(cO){var cT=R(cO);if(!cT){return}var cQ=cM(cO);var cR=h.Event("cellclick");af.trigger(cR,[cT,cQ,cP]);if(cR.isDefaultPrevented()){return}var cN=false;if(h(cO).hasClass("blist-opener")&&!h(cO).hasClass("blist-opener-inactive")){O();C(bQ);cA.expand(cT);cN=true}if(!E&&!cN&&(!cf||!cf.isActive())&&bI.selectionEnabled){if(cP.shiftKey){cA.selectRowsTo(cT)}else{cA.selectRow(cT)}x(cT.id)}}};var b8,b9;var bH=function(cN){var cO=cN.originalEvent;b8=cO.targetTouches[0].clientY;b9=cO.targetTouches[0].clientX};var M=function(cQ){var cR=cQ.originalEvent;if(_.isUndefined(cR.targetTouches)||(cR.targetTouches.length!==1)){return false}var cP=cm.find(".blist-table-scrolls");var cN=b8-cR.targetTouches[0].clientY;cN/=2;cP[0].scrollTop=cP[0].scrollTop+cN;var cO=b9-cR.targetTouches[0].clientX;cP[0].scrollLeft=cP[0].scrollLeft+cO};var aq;var b2=function(cP){u=cP.target;if(E){return}bY=bg(cP);var cO=h(u);if(cO.hasClass("commentLink")||cO.parent().hasClass("commentLink")){return}if(cO.is(".blist-table-scrolls, .blist-table-expander")){return}if(cg[bQ]&&cO.parents().andSelf().index(S[bQ])>=0){return}aB={x:cP.clientX,y:cP.clientY};if(aI&&aC!=3){if(cO.closest(".action-item").length<1&&(cO.closest(".blist-tdh").length<1||aC==2)){u=null;bY=null;y=true;if(aC!=4){cP.stopPropagation()}cP.preventDefault()}if(cg[bQ]){C(true)}if(cf){cf.deactivate();aN()}if(cO.closest(".action-item").length<1){cP.preventDefault()}return}V=null;aw=bB(u);if(cf){var cN=bg(cP);if(h(cN).is(".blist-opener, .blist-tdh, .blist-table-row-handle, .blist-column-adder")){return}if(cN&&aE&&aE.index(cN)>=0){aq=aE}else{aq=null;if(!cP.shiftKey&&!cP.metaKey){O()}}if(cN&&ct(cN,cP)){if(cg[bQ]){C(true)}V=cN}}};var aQ=function(cP){aB=null;if(cg[bQ]){return}if(!E&&y){$curHeaderSelect=null;origColSelects=null;curColSelects={};y=false;if(aC==2){v(cP,true)}if(aC>1){ad=true}b7(cP);cP.stopPropagation();cP.preventDefault();return true}var cO=h(cP.target);if(cO.closest(".action-item").length>0){return}if(cO.parents().index(cm)<0){return}if(cO.hasClass("commentLink")||cO.parent().hasClass("commentLink")){return}var cN=bg(cP);var cQ=false;if(!E&&cf&&cN!==null&&cN==bY){var cR=(cf.isActive()&&aE)?aE[0]:null;if(cR&&aq&&aq.index(cR)>=0){cQ=bk(cR)}else{if(cR){aq=aE}}if(!cQ){J()}}if(u&&u==cP.target&&!h(u).is("a")){h(u).trigger("table_click",cP)}if(!E&&cf&&!cQ){cl()}};var bp=function(cN){var cP=h(cN.target);if(cP.hasClass("commentLink")||cP.parent().hasClass("commentLink")){cN.preventDefault();var cO=cP.closest(".commentLink");cO.trigger("comment_click",[cO.data("rowId"),cO.data("tableColumnId")])}};var bE=function(cO){if(E){return}if(cg[bQ]&&h(cO.target).parents().andSelf().index(S[bQ])>=0){return}u=cO.target;if(cf){var cN=bg(cO);if(cN){bk(cN)}}};var cB=1;var a3=false;var cs=function(cN,cP,cO){var cQ=cf.navigateX(cN,cP,cO);if(cQ){bA(cQ,cP,false,cO)}};var cr=function(cN,cP,cO){var cQ=cf.navigateY(Math.floor(cN),cP,cO);if(cQ){bA(cQ,cP,false,cO)}};var aa=function(cN){if(cf){bn.val(cf.getSelectionDoc());bn[0].select()}};var X=false;var bd=function(cN){X=true;bX(cN)};var a1=function(){a3=true};var b5=function(){a3=false};var bo=function(){if(!a3){return false}if(document.selection){return document.selection.createRange().text.length>0}return Math.abs(bn.selectionEnd-bn.selectStart)>0};var ab=function(){if(bo()){return}var cN=bn.val();if(!cN){return}br(cN)};var br=function(cO){var cN=(cf.isActive()&&aE)?aE[0]:null;if(!cN){return}bk(cN,null,cO)};var G=function(cN){if(cf&&cf.isActive()){if(!bo()){bn.val("")}setTimeout(ab,1)}if(X){X=false;return}bX(cN)};var bX=function(cO){if(!cf){return}switch(cO.keyCode){case 90:if(cO.metaKey){if(cA.canUndo()){cA.undo()}}else{return}break;case 89:if(cO.metaKey){if(cA.canRedo()){cA.redo()}}else{return}break;case 33:cr(-cB,cO);break;case 34:cr(cB,cO);break;case 37:cs(-1,cO);break;case 38:cr(-1,cO);break;case 39:cs(1,cO);break;case 40:cr(1,cO);break;case 8:br("");break;case 9:var cQ=cO.shiftKey?-1:1;cO.shiftKey=false;cs(cQ,cO,true);break;case 13:if(!cO.shiftKey&&aE&&aE.hasClass("blist-opener")&&!aE.hasClass("blist-opener-inactive")){cA.expand(R(aE[0]))}else{cQ=cO.shiftKey?-1:1;cO.shiftKey=false;cr(cQ,cO,true)}break;case 27:O();break;case 113:var cP=aE?aE[0]:null;if(cP){if(bk(cP)){cO.preventDefault();return}}break;default:return}aN();J();setTimeout(cl,0);try{cO.preventDefault()}catch(cN){}};var bB=function(cN){return h(cN).closest(".blist-table-scrolls")[0]==bs[0]};if(bI.simpleCellExpand){h(".blist-td:not(.blist-td-popout)").live("mouseover",function(cR){var cT=h(this);var cN=0;cT.children().each(function(){cN+=h(this).outerWidth(true)});if(cN<=cT.innerWidth()){return}var cS=cT.offset();cS.top+=cT.offsetParent().scrollTop();var cQ=cT.clone();var cP;var cO=function(){cQ.stop().fadeOut("fast",function(){cQ.remove()})};cQ.addClass("blist-td-popout").css("left",cS.left).css("top",cS.top).mouseover(function(){clearTimeout(cP)}).mouseleave(cO).fadeIn();cT.mouseleave(function(){cP=setTimeout(cO,0)});h(document.body).append(cQ)})}var U='<input type="text" class="blist-table-navigator hiddenTextField" /><div class="blist-table-locked-scrolls">   <div class="blist-table-locked-header">&nbsp;</div>   <div class="blist-table-locked">     <div class="blist-table-render">&nbsp;</div>   </div>   <div class="blist-table-locked-footer">&nbsp;</div></div><div class="blist-table-top">  <div class="blist-table-header-scrolls">    <div class="blist-table-header">&nbsp;</div>    <div class="indicator-container"></div></div></div><div class="blist-table-scrolls">  <div class="blist-table-inside">    <div class="blist-table-render">&nbsp;</div>    <div class="blist-table-no-results hide">'+h.t("controls.grid.no_rows")+'</div>  </div></div><div class="blist-table-footer-scrolls">    <div class="blist-table-footer">&nbsp;</div></div><div class="blist-table-pagination"></div><div class="blist-table-util"></div>';h(document).mouseup(aQ);var cm=af.addClass("blist-table").mousedown(b2).mousemove(b7).click(bp).dblclick(bE).html(U);if(bI.columnDrag){cm.append(h('<div class="dropIndicator"/>'));ap=h(".dropIndicator",cm).css("left",-10000).hide()}var Y=cm.find(".blist-table-locked-scrolls");var cH=Y.find(".blist-table-locked-header");var aj=Y.find(".blist-table-locked").bind("table_click",co);var au=aj.find(".blist-table-render");var a7=Y.find(".blist-table-locked-footer");var aW=cm.find(".blist-table-top");var aD=aW.find(".blist-table-header-scrolls");var L=aD.find(".blist-table-header");var bs=cm.find(".blist-table-scrolls").scroll(_.throttle(function(){bl();ao()},200)).bind("touchstart",bH).bind("touchmove",M);var N=bs.find(".blist-table-inside").mouseout(b1).bind("table_click",co);var bc=N.find(".blist-table-render");var cd=bc[0];var ae=N.find(".blist-table-no-results");var ax=1;var aU=1;var aR=cm.find(".blist-table-footer-scrolls");var bJ=aR.find(".blist-table-footer");var a8=cm.find(".blist-table-pagination");var ac=h(document.createElement("div"));var P=ac[0];var aT=cm.find(".blist-table-util");var bG=aT[0];var bn=cm.find(".blist-table-navigator").keydown(bd).keypress(G).bind("copy",aa).bind("blur",b5);aj.css("top",L.outerHeight());var aw=false;if(cf){var cc=function(cN){if(cf.isActive()&&!aw&&!bB(cN.target)){cf.deactivate();aN()}aw=false};h(document).mousedown(cc)}var bF=(function bF(){var cP=h('<div style="width:50px;height:50px;overflow:hidden;position:absolute;top:-200px;left:-200px;"><div style="height:100px;"></div></div>');h("body").append(cP);var cO=cP[0].clientWidth;cP.css("overflow","scroll");var cN=cP[0].clientWidth;h(cP).remove();return cO-cN})();var aO=function(){if(!aJ||a9<1){return}c("updateLayout.size.header");aD.height(L.outerHeight());g("updateLayout.size.header");c("updateLayout.size.scrolls");bs.height(cm.height()-aW.outerHeight()-(bs.outerHeight()-bs.height())-1);bs.width(cm.width()-(bs.outerWidth()-bs.width()));g("updateLayout.size.scrolls");if(bs.height()<5){return}c("updateLayout.size.calculate");var cY=bs[0].clientHeight;cB=(cY/a9)||1;var cS=cA!==undefined?cA.length():0;var cU=a9*cS;g("updateLayout.size.calculate");c("updateLayout.size.footer");var cT=0;if(aR.is(":visible")){cT+=aR.outerHeight()-1}if(a8.is(":visible")){cT+=a8.outerHeight()-1}if(cU+cT<cY){cT+=cY-cT-cU}g("updateLayout.size.footer");c("updateLayout.size.scale");var cX=cU;cU/=ax;N.height(cU+cT);while(N.height()<cU+cT-2){ax++;cU=cX/ax;N.height(cU+cT)}var cQ=cY-cT;var cN=(cQ/a9)||1;aU=((cU-cQ)/(cS-cN))||1;aj.height(cU+cT);if(bc.position().top+bc.height()>cU+cT){var cP=cU+cT-bc.height();bc.css("top",cP);au.css("top",cP)}g("updateLayout.size.scale");c("updateLayout.size.scrollUpdate");bs.scroll();g("updateLayout.size.scrollUpdate");c("updateLayout.renderRows");g("updateLayout.renderRows");c("updateLayout.configWidths");T();g("updateLayout.configWidths");c("updateLayout.footer");var cR=parseFloat(bs.css("border-bottom-width"))+1;var cW=parseFloat(bs.css("border-bottom-width"))+aR.outerHeight();if(bs[0].scrollWidth>bs[0].clientWidth){cR+=bF;cW+=bF}var cV=a8.filter(":visible").outerHeight()||0;a7.css("bottom",cV-2);Y.height(cm.height()-cR);aR.css("bottom",cW+cV-2);a8.css("bottom",bF);if(bF>0){a8.css("width","calc(100% - {0}px)".format(bF))}var cO=bs.outerHeight()-bs.height();if(bs[0].scrollHeight>bs[0].clientHeight){cO+=bF}aR.css("margin-right",cO);g("updateLayout.footer")};if(bI.manualResize){af.bind("resize",aO)}else{h(window).resize(aO)}var s=0;var a6=0;var bl=function(){c("onScroll");h(document).trigger("click");var cO=bs[0].scrollLeft;var cN=false;if(cO!=s){L[0].style.left=-cO+"px";bJ[0].style.left=-cO+"px";s=cO;cN=true}var cP=function(){var cR=bs[0].scrollTop;if(cR!=a6){var cT=cR-a6;var cS=Math.abs(cT);if(cS<75&&cS/aU>cB*0.8){var cQ=Math.ceil(cB*0.5*aU)*(cT<0?-1:1);cR=a6+cQ;bs[0].scrollTop=cR}aj.css("top",L.outerHeight()-cR);if(h.browser.msie){N.find(".select-overlay, .disabled-overlay").css("top",cR)}a6=cR}};if(cN){setTimeout(cP,50)}else{cP()}g("onScroll")};var ai=ag+"_blistTable";var cK;var av;var az;var b4=function(cO,cN){blist.styles.addStyle(ai,cO,cN)};var F=function(cN){return blist.styles.getStyle(ai,cN)};var r=function(cN){return ag+"-c"+cN.id};var bD=function(cO){var cN=F("column-"+cO.id);if(!cN){throw"Uninitialized column style access for "+cO.id}return cN};var aX=function(cN){b4("column-"+cN.id,"."+r(cN))};(function(){av=ag+"-ghost";az=ag+"-opener";b4("ghostStyle","."+av);b4("openerStyle","div."+az);b4("rowStyle","#"+ag+" .blist-tr");b4("unlockedRowStyle","#"+ag+" .blist-table-inside .blist-tr");b4("cellStyle","#"+ag+" .blist-cell");b4("groupHeaderStyle","#"+ag+" .blist-td-header")})();var bi=[];var aZ=[];var cq=[];var aL=[];var cL;var aP;var a5;var a9;var bh;var al;var cu;var aS;var cb=0;var p=0;var bO=[];var I=[];var a0;var bx;var b6;var aG={};var o=function(cU,cX,cV,c3,cR,c0,cN,c1){if(!h.isBlank(cR.visibleChildColumns)&&cN==0){var cQ=cR.visibleChildColumns;if(!_.isEmpty(c3.data[cR.lookup])||cA.useBlankRows()){cU.push('<div class="',r(cR)," blist-td blist-tdh blist-opener ",az,'"></div>');if(bI.showRowHandle){cU.push('<div class="',r(b6),' blist-td blist-tdh blist-table-row-handle">',"</div>")}for(var cS=0;cS<cQ.length;cS++){var cP=cQ[cS];cU.push('<div class="blist-td blist-tdh ',r(cP)," ",cP.renderTypeName,'" parentColId="',cP.parentColumn.id,'" colId="',cP.id,'">',(cG()?'<div class="blist-th-icon"></div>':""),'<a class="menuLink action-item" href="#column-menu"></a>','<div class="button-wrapper"> <div class="info-button action-item"></div> </div>','<span class="info-container">','<div class="name-wrapper">','<span class="blist-th-name">',l(cP.name),"</span></div></span></div>")}if(bI.showAddColumns){cU.push('<div class="',r(cR),' blist-td blist-tdh blist-column-adder">','<div class="blist-column-adder-icon" ','title="'+h.t("controls.grid.add_column")+'"></div></div>')}}else{cU.push('<div class="',r(cR)," blist-td blist-tdh blist-opener blist-opener-inactive ",az,'"></div>');if(bI.showRowHandle){cU.push('<div class="',r(b6),' blist-td blist-tdh blist-table-row-handle handle-inactive"></div>')}for(cS=0;cS<cQ.length;cS++){var cP=cQ[cS];cU.push('<div class="blist-td blist-tdh ',r(cP),'" parentColId="',cP.parentColumn.id,'" colId="',cP.id,'"></div>')}if(bI.showAddColumns){cU.push('<div class="',r(cR),' blist-td blist-tdh blist-column-adder">','<div class="blist-column-adder-icon" ','title="'+h.t("controls.grid.add_column")+'"></div></div>')}}}else{if(!h.isBlank(cR.visibleChildColumns)){var cQ=cR.visibleChildColumns;if(!h.isBlank(c3.data[cR.lookup])){cU.push('<div class="blist-td blist-opener-space ',az,'"></div>');if(bI.showRowHandle){cU.push('<div class="blist-td ',r(b6),' blist-table-row-handle">');bI.rowHandleRenderer(cU,cX,cV,c3,cR,c1);cU.push("</div>")}for(var cT=0;cT<cQ.length;cT++){o(cU,cX,cV,c3,cQ[cT],cT,cN,c1)}if(bI.showAddColumns){cU.push('<div class="blist-td ','blist-column-adder-space blist-column-adder">',"</div>")}}else{cU.push('<div class="blist-td blist-opener-space ',"blist-tdfill ",az,'"></div>');if(bI.showRowHandle){cU.push('<div class="blist-td blist-tdfill ',r(b6),' blist-table-row-handle"></div>')}for(var cT=0;cT<cQ.length;cT++){cU.push('<div class="blist-td blist-tdfill blist-td-colfill ',r(cQ[cT]),'"></div>')}if(bI.showAddColumns){cU.push('<div class="blist-td blist-column-adder-space blist-column-adder ','blist-tdfill"></div>')}}}else{if(cR.renderTypeName=="fill"){cU.push('<div class="blist-td blist-tdfill ',r(cR),(c0==0?" initial-tdfill":""),'">&nbsp;</div>')}else{var cY=cR.renderType;var c2=cR.cls||cY.cls;c2=c2?" blist-td-"+c2:"";var cW=c3;if(!h.isBlank(cR.parentColumn)){cW=c3.data[cR.parentColumn.lookup]}var cO=cW.invalid[cR.lookup]?blist.datatypes.invalid:cY;cU.push('<div class="blist-td ',r(cR),c2,(cR.format.drill_down?" drill-td":""),(cR.format.align?" align-"+cR.format.align:""),(cW.invalid[cR.lookup]?" invalid":""),(cW.changed&&cW.changed[cR.lookup]?" saving":""),(cW.error&&cW.error[cR.lookup]?" error":""),(cW.sessionMeta&&cW.sessionMeta.highlightColumn==cR.id?" blist-td-highlight":""));if(h.isBlank(cR.parentColumn)){cU.push(" ",((c1.cellClasses[c3.id]||{})[cR.lookup]||[]).join(" "))}cU.push('">');if(cR.format.drill_down){var cZ=cW.data[cR.lookup];if(!h.isBlank(cZ)&&!_.isString(cZ)){cZ=cZ.toString()}cU.push('<a class="drillDown" cellvalue="',h.escapeQuotes(h.htmlStrip(cZ)),'" column="',cR.fieldName,'" href="#drillDown"></a>')}cU.push(cO.renderer(cW.data[cR.lookup],cR,false,false,c1));if(h.isBlank(cR.parentColumn)&&!h.isBlank((cW.annotations||{})[cR.lookup])){cU.push('<span class="annotation ',cW.annotations[cR.lookup],'"></span>')}cU.push("</div>")}}}};var an=function(cO,cR,cS){for(var cP=0;cP<cO.length;cP++){var cQ=cO[cP];if(!h.isBlank(cQ.visibleChildColumns)&&cS==0){cR.push({renderTypeName:"opener",skippable:true,skipCount:cQ.visibleChildColumns.length,mcol:cQ,logical:cQ.id});if(bI.showRowHandle){cR.push({renderTypeName:"handle",canFocus:false,mcol:cQ,logical:cQ.id})}for(var cN=0;cN<cQ.visibleChildColumns.length;cN++){cR.push({renderTypeName:"header",canFocus:false,mcol:cQ.visibleChildColumns[cN],logical:cQ.id})}if(bI.showAddColumns){cR.push({renderTypeName:"adder",canFocus:false,mcol:cQ,logical:cQ.id})}}else{if(!h.isBlank(cQ.visibleChildColumns)){cR.push({renderTypeName:"nest-header",canFocus:false,skippable:true,skipCount:cQ.visibleChildColumns.length,mcol:cQ,logical:cQ.id});if(bI.showRowHandle){cR.push({renderTypeName:"nest-header",canFocus:false,skippable:true,mcol:cQ,logical:cQ.id})}an(cQ.visibleChildColumns,cR,cS);if(bI.showAddColumns){cR.push({renderTypeName:"nest-header",canFocus:false,skippable:true,mcol:cQ,logical:cQ.id})}}else{if(cQ.renderTypeName=="fill"){cR.push({renderTypeName:"fill",canFocus:false,mcol:cQ})}else{cR.push({mcol:cQ,logical:cQ.id})}}}if(bI.generateHeights){bD(cQ).height=a5+"px"}}};var q=function(){c("initMeta");O();C(bQ);bi=[];cq=[];bO=[];I=[];for(var cR=0;cR<cA.columns().length;cR++){cq[cR]=[];bO[cR]=0;I[cR]=0;var cT=cA.columns()[cR];for(var cS=0;cS<cT.length;cS++){var cN=cT[cS];if(cN.hasOwnProperty("percentWidth")){I[cR]+=cN.percentWidth;if(cN.minWidth){bO[cR]+=cN.minWidth}cN.width=0;cq[cR].push(cN)}if(cR==0){bi.push(cN)}aX(cN);if(!h.isBlank(cN.visibleChildColumns)){_.each(cN.visibleChildColumns,function(cX){aX(cX)})}}}if(cq[0].length<1&&bI.showGhostColumn){cq[0].push({percentWidth:100,minWidth:bI.ghostMinWidth,ghostColumn:true});bO[0]+=bI.ghostMinWidth;I[0]+=100}else{bI.showGhostColumn=false}aZ=[];if(bI.showRowNumbers){aZ.push(bx={id:"rowNumberCol",cls:"blist-table-row-numbers",measureText:Math.max(cA.length(),100),renderer:function(cZ,cX,cY,c0){c0.type=="blank"?cZ.push(h.t("controls.grid.new_row")):c0.noMatch?cZ.push('<span title="'+h.t("controls.grid.row_does_not_match")+'">X</span>'):cZ.push('<a href="',cA.view.url,"/",c0.id,'" ','title="'+h.t("controls.grid.view_row")+'" class="noInterstitial noRedirPrompt">',(cY+1),"</a>")},footerText:h.t("controls.grid.totals")});aX(bx)}if(bI.showRowHandle){aZ.push(b6={id:"rowHandleCol",cls:"blist-table-row-handle",width:bI.rowHandleWidth,renderer:bI.rowHandleRenderer});aX(b6)}bh=bu();bG.innerHTML='<div class="blist-td">x</div>';var cU=h(bG.firstChild);var cV={width:Math.max(0,Math.floor(cU.width())),height:Math.max(0,cU.height())};var cP={width:cU.outerWidth(),height:cU.outerHeight()};al=cP.width-cV.width;a5=cV.height;a9=cP.height;F("rowStyle").height=a9+"px";ax=1;if(bI.generateHeights&&bI.showGhostColumn){F("ghostStyle").height=a5+"px"}if(bI.generateHeights){F("cellStyle").height=a5+"px"}cu=0;_.each(aZ,function(c0){bG.innerHTML='<div class="blist-tr"><div class="'+(c0.width?r(c0):"")+" "+(c0.cls||"")+' blist-td">'+(c0.measureText||"")+"</div></div>";var cX=h(bG).find(".blist-td");var cZ=bD(c0);if(c0.width){cZ.width=c0.width+"px"}else{var cY=Math.floor(cX.width());if(cY>=0){cZ.width=cY+"px"}}cu+=cX.outerWidth();if(bI.generateHeights){cZ.height=a5+"px"}});aS=cV.width*1.5;if(bI.showAddColumns){bG.innerHTML='<div class="blist-td blist-column-adder">x</div>';cU=h(bG.firstChild);p=Math.floor(cU.width())+al}if(bI.showRowHandle){cb=parseFloat(bD(b6).width)+al}F("openerStyle").width=aS+"px";if(bI.generateHeights){F("openerStyle").height=a5+"px"}var cW={permissions:{canRead:cA.canRead(),canWrite:cA.canWrite(),canAdd:cA.canAdd(),canDelete:cA.canDelete(),canEdit:cG()},cellClasses:aG,modelView:cA.view};for(cS=0;cS<cA.columns().length;cS++){var cT=cA.columns()[cS];var cQ=aL[cS]=[];an(cT,cQ,cS)}if(cf){cf.updateModel(cA);cf.updateLayout(aL)}else{cf=bI.cellNav?new blist.data.TableNavigation(cA,aL,bn):null}var cO=function(cZ,cX,cY,c0){cZ.push('class="blist-tr',(cY%2?" blist-tr-even":""),(c0.noMatch?" blist-tr-noMatch":""),(!h.isBlank(c0.level)?" blist-tr-level"+c0.level:""),(c0.level>0?" blist-tr-sub":""),(c0.type?" blist-tr-"+c0.type:""),(c0.expanded?" blist-tr-open":""),(c0.pending?" blist-tr-pending":""),(c0.sessionMeta&&c0.sessionMeta.highlight?" blist-tr-highlight":""),(c0.groupLast?" last":""),'" style="top:',(cX*a9),"px",(c0.color?";background-color:"+c0.color:""),';"')};cL=function(c1,cY,c0,c2){c1.push('<div id="',ag,"-r",c2.id,'"');cO(c1,cY,c0,c2);c1.push(">");var c3=c2.level||0;if(c3<cA.columns().length){var cX=cA.columns()[c3];for(var cZ=0;cZ<cX.length;cZ++){o(c1,cY,c0,c2,cX[cZ],cZ,c3,cW)}}if(bI.showGhostColumn){c1.push('<div class="blist-td ',av,' blist-table-ghost"></div>')}c1.push("</div>")};aP=function(c0,cX,cZ,c1){c0.push('<div id="',ag,"-l",(c1.id||c1[0]),'" ');cO(c0,cX,cZ,c1);c0.push(">");for(var cY=0;cY<aZ.length;cY++){var c2=aZ[cY];c0.push('<div class="',(c2.cls||"")," blist-td ",r(c2),'">');c2.renderer(c0,cX,cZ,c1,null,cW);c0.push("</div>")}c0.push("</div>")};F("groupHeaderStyle").left=cu+"px";F("unlockedRowStyle").left=cu+"px";aD.css("margin-left",cu);aR.css("margin-left",cu);g("initMeta");T()};var T=function(){c("configureWidths");c("configureWidths.levels");a0=0;var cO=cA.columns();for(var cQ=0;cQ<cO.length;cQ++){bK(cO[cQ],cQ)}g("configureWidths.levels");F("groupHeaderStyle").width=Math.max(0,(a0-cu-al))+"px";var cP=bs.width();if(bs[0].scrollHeight>bs[0].clientHeight){cP-=bF}var cN=Math.max(a0,cP);L.width(cN);bJ.width(cN);N.width(cN);Y.width(cu);aj.width(cu);g("configureWidths")};var bK=function(cR,cO){var cX=cu;if(cO==0&&bI.showGhostColumn){cX+=al}for(var cT=0;cT<cR.length;cT++){var cY=cR[cT];var cU;if(!h.isBlank(cY.visibleChildColumns)){if(cO==0){cU=aS+al;cU+=cb;cU+=p;var cQ=cY.visibleChildColumns;for(var cS=0;cS<cQ.length;cS++){cU+=cQ[cS].width+al}}else{cU=null;bK(cY.visibleChildColumns,cO)}}else{if(cY.fillFor){cU=0;for(cS=0;cS<cY.fillFor.length;cS++){var cW=cY.fillFor[cS];cU+=(cW.width||parseFloat(bD(cW).width))+al}}else{cU=(cY.width||0)+al}}if(cU){cX+=cU;try{var cN=bD(cY)}catch(cV){continue}var cP=(cU-al)+"px";if(cN.width!=cP){cN.width=cP}}}cX+=bO[cO];ce(cO,cX);if(cX>a0){a0=cX}};var ce=function(cT,cO){if(cq[cT] instanceof Array&&cq[cT].length>0){var cS=cO;var cN=bs.width()-cS;if(bs[0].scrollHeight>bs[0].clientHeight){cN-=bF}cN=Math.max(cN,0);for(cQ=0;cQ<cq[cT].length;cQ++){var cR=cq[cT][cQ];if(cR.ghostColumn){F("ghostStyle").width=(cR.minWidth+cN)+"px"}else{bD(cR).width=((cR.minWidth||0)+((cR.percentWidth/I[cT])*cN))+"px"}}if(cT==0&&!bI.showGhostColumn){cS=cu;for(var cQ=0;cQ<bi.length;cQ++){var cP=bi[cQ];cP.left=cS;cS+=al;cS+=cP.width||parseFloat(bD(cP).width)}}}};var cJ=function(cP,cN){if(E){return}var cO=cN.closest(".blist-th").data("column");if(h.isBlank(cO)){return}h(cP.currentTarget).removeClass("hover").data("column-clicked",false);if(cN.closest(".filter").length>0){O();af.trigger("clear_filter",[cO]);return}if((cN.closest(".sort").length>0||(!cP.metaKey&&!cP.shiftKey))&&((cO.renderType!==undefined&&cO.renderType.sortable)||cO.sortable)){O();ck(cO);return}if(cP.metaKey){cI(cO,!cf.isColumnSelected(cO))}else{if(cP.shiftKey){aY(cO)}else{O()}}};var w=function(){c("renderHeader-assemble");var cQ=[];for(var cP=0;cP<bi.length;cP++){var cO=bi[cP];var cN=cO.cls?" blist-th-"+cO.cls:"";var cR=cO.name==null?"":l(cO.name);cQ.push('<div class="blist-th ',!cP?"blist-th-first ":"",(cO.dataTypeName||cO.renderTypeName)," ",r(cO),cN,'" colId="',cO.id,'">');if(cO.renderTypeName=="nested_table"){cQ.push('<div class="blist-tdh blist-opener ',az,'"></div>')}if(bI.columnDrag){cQ.push('<div class="dragHandle"',bI.generateHeights?' style="height: '+a9+'px"':"","></div>")}cQ.push(' <a class="menuLink action-item" href="#column-menu"></a>','<div class="button-wrapper"> <div class="info-button action-item"></div> </div>','<span class="info-container',cG()?" icon-display":"",'">');if(cG()){cQ.push('<span class="blist-th-icon"></span>')}cQ.push('<div class="name-wrapper"><span class="blist-th-name">',cR,"</span></div>","</span>",'<div class="indicator-container">','<div class="filter" title="'+h.t("controls.filter.actions.remove_filter")+'"',bI.generateHeights?' style="height: '+a9+'px"':"","></div>",'<div class="sort sort-desc" title="'+h.t("controls.grid.sort_ascending")+'"',bI.generateHeights?' style="height: '+a9+'px"':"","></div>","</div>","</div>")}if(bI.showGhostColumn){cQ.push('<div class="blist-th blist-table-ghost ',bi.length<1?"blist-th-first ":"",av,'">'+(bI.showAddColumns?'<div class="blist-column-adder add-column" title="'+h.t("controls.grid.add_column")+'"></div>':"")+'<div class="indicator-container"></div></div>')}cQ=cQ.join("");g("renderHeader-assemble");c("renderHeader-render");L.trigger("rerender");L[0].innerHTML=cQ;g("renderHeader-render");c("renderHeader-augment");h(".blist-th",L).each(function(cT){if(cT>=bi.length){return}bi[cT].dom=this;var cV=h(this);var cU=false;var cW=function(){cU=true;cV.mouseleave(function(){h(this).removeClass("hover")}).bind("click",function(cY){if(E){return}if(ad){ad=false;return}var cX=h(cY.target);if(cX.closest(".action-item").length>0){return}if(cX.closest(".blist-th .indicator-container, .blist-th .dragHandle, .blist-th .action-item").length<1){if(cV.data("column-clicked")){}else{cV.data("column-clicked",true);setTimeout(function(){if(cV.data("column-clicked")){cJ(cY,cX)}},500)}}else{cJ(cY,cX)}}).bind("dblclick",function(cX){if(h(cX.target).closest(".blist-th .indicator-container, .blist-th .dragHandle, .blist-th .action-item").length<1){cV.data("column-clicked",false);af.trigger("column_name_dblclick",[cX])}});if(bI.columnDrag){cV.draggable({appendTo:".blist-table",axis:"x",drag:function(cX,cY){var cZ=aF(cX);if(t!=cZ){t=cZ;bj(t)}},handle:".dragHandle",helper:function(cY){var cX=h('<div class="blist-th-drag"/>');cX.append(h(this).clone());return cX},opacity:0.85,start:function(cX,cY){y=true;aC=4},stop:function(cY,cZ){aC=null;ap.css("left",-10000).hide();if(t==null){return}var cX=h(this).data("column");af.trigger("column_moved",[cX,t]);t=null}})}if(bI.headerMods!=null){bI.headerMods(bi[cT])}};cV.data("column",bi[cT]).mouseenter(function(){if(!cU){cW()}if(E){return}if(!y||aC!=4){h(this).addClass("hover")}});cC(cV)});var cS="";h.each(aZ,function(cT,cU){cS+='<div class="blist-th '+(cU.cls||"")+" "+r(cU)+'"><div class="indicator-container"></div></div>'});cH.html(cS);H();g("renderHeader-augment")};var H=function(){cw();b0();cm.toggleClass("indicators-inactive",((cA.view.metadata.jsonQuery||{}).order||[]).length<=0&&_.all(bi,function(cN){return h.isBlank(cN.currentFilter)}));aj.css("top",L.outerHeight()-bs[0].scrollTop)};var cC=function(cN,cR){var cP=cN;if(cR){cN=cP.clone();aT.append(cN);cN.removeClass("narrow narrower")}var cT=cN.find(".info-container");var cO=cT.outerWidth(true)+(cP.find(".info-button").outerWidth(false)*2);var cQ=cN.width();if(cO+20>cQ){cO+=parseInt(cT.css("left"));if(cO>cQ){var cS=cN.find(".blist-th-icon").outerWidth(true)||0;cP.toggleClass("narrower",cO-cS>cQ);cP.addClass("narrow")}else{if(cR){cP.removeClass("narrow narrower")}}}else{if(cR){cP.removeClass("narrow narrower")}}if(cR){cN.remove()}};var t=null;var ap;var aF=function(cR){var cO=cR.originalEvent.pageX;var cQ=h(".blist-th:not(.ui-draggable-dragging, .blist-table-ghost)",L);if(cO<cQ.eq(0).offset().left){return 0}var cP=cQ.eq(cQ.length-1);if(cO>cP.offset().left+cP.outerWidth()){return cQ.length}var cN;cQ.each(function(cT){var cV=h(this);var cW=cV.offset().left;if(cO<cW){return true}var cU=cV.outerWidth();var cS=cW+cU;if(cO>cS){return true}cN=(cO-cW)<(cU/2)?cT:cT+1;return false});return cN};var bj=function(cQ){var cP=h(".blist-th:not(.ui-draggable-dragging, .blist-table-ghost)",L);var cO;if(cQ>=cP.length){var cN=cP.eq(cP.length-1);cO=cN.offset().left+cN.outerWidth()}else{cO=cP.eq(cQ).offset().left}cO+=cu-aD.offset().left-ap.width()/2;ap.css("left",cO).show()};var cD=function(cN){c("updateHeader");H();g("updateHeader")};var bf=false;var bw=function(){if(bf){return}var cN=function(){var cQ=[];var cT=false;var cR=function(cW){var cV=cW.cls?" blist-tf-"+cW.cls:"";var cU=cW.aggregates[cW.format.aggregate];cT=cT||!h.isBlank(cU);var cX=cU;if(!h.isBlank(cU)&&_.include(["sum","average","maximum","minimum"],cW.format.aggregate)){var cY=cW;if(cW.format.aggregate=="average"){cY=h.extend(true,{format:{precision:3}},cW)}cX=cW.renderType.renderer(cU,cY)}cQ.push('<div class="blist-tf ',!cP?"blist-tf-first ":"",r(cW),cV,'" title="',(cW.format.aggregate||"").capitalize(),'" colId="',cW.id,'">','<span class="blist-tf-value">',(cX||""),"</span></div>")};for(var cP=0;cP<bi.length;cP++){var cO=bi[cP];if(!h.isBlank(cO.visibleChildColumns)){cQ.push('<div class="blist-tf blist-opener ',ag,'-opener"></div>');if(bI.showRowHandle){cQ.push('<div class="'+r(b6)+' blist-tf blist-table-row-handle"></div>')}_.each(cO.visibleChildColumns,function(cU){cR(cU)});if(bI.showAddColumns){cQ.push('<div class="blist-tf blist-column-adder"></div>')}}else{cR(cO)}}if(bI.showGhostColumn){cQ.push('<div class="blist-tf blist-table-ghost ',bi.length<1?"blist-tf-first ":"",av,'"></div>')}if(cT){bJ.html(cQ.join(""));aR.show();a7.show()}else{aR.hide();a7.hide()}var cS="";_.each(aZ,function(cU){cS+='<div class="blist-tf '+(cU.cls||"")+" "+r(cU)+'"><span class="blist-tf-value">'+(cU.footerText||"")+"</span></div>"});a7.html(cS);bf=false};if(cA.getAggregates(function(){_.defer(cN)})){bf=true}};var b3=function(){return h.t("controls.grid.viewing_current_page",{current:h.commaify(cA.currentBucketIndexOrUndefined()+1),total:h.commaify(cA.totalBuckets())})};var ay=function(cO,cN){a8.find(".info").text(b3())};var n=function(){bs.scrollTop(0)};var bz=function(){aO();bs.scrollTop(bs[0].scrollHeight)};var K=function(cN){if((cN||{}).goToBottom){bz()}else{n()}ao();ay();a8.find(".start, .previous").toggleClass("disabled",cA.inFirstBucket()).end().find(".next, .end").toggleClass("disabled",cA.inLastBucket()).end().find(".rowCount").text(h.t("controls.grid.row_count",{count:h.commaify(cA.dataLength())}))};var cz=function(){var cN=cm.find(".blist-table-pagination");if(!cA.usingBuckets()){cN.hide();return}else{cN.show()}var cO={_:"li",className:"rowCount",contents:h.t("controls.grid.row_count",{count:h.commaify(cA.dataLength())})};var cQ={_:"li",className:"bucketSize",contents:h.t("controls.grid.page_size",{pageSize:h.commaify(cA.view.bucketSize)})};var cP=function(cR){return{_:"li",contents:[{_:"a",href:"#"+cR,className:[cR,"button"].join(" "),contents:[{_:"span",className:"icon"}],title:h.t("controls.grid.{0}_page".format(cR))}]}};cN.html(h.tag2({_:"ul",className:"navigation",contents:[cO,cP("start"),cP("previous"),{_:"li",className:"info",contents:b3()},cP("next"),cP("end"),cQ]}));if(cA.totalBuckets()<=1){cN.find("li:not(.rowCount)").remove()}cN.find(".start, .previous").toggleClass("disabled",cA.inFirstBucket()).end().find(".next, .end").toggleClass("disabled",cA.inLastBucket());h(".button",cN).click(function(cS){var cR=h(this);cS.preventDefault();if(cR.is(".disabled")){return}switch(h.hashHref(cR.attr("href"))){case"start":cA.setRowBucket(0,"normal");K();break;case"previous":cA.setRowBucket(cA.currentBucket.start-1);K();break;case"next":cA.setRowBucket(cA.currentBucket.finish+1);K();break;case"end":cA.setRowBucket(cA.dataLength(),"reversed");K({goToBottom:true});break}})};var cn=function(cN){ae.toggleClass("hide",!cN)};var bb={};var bN={};var bC={};var cE=function(cO){var cN=function(){P.innerHTML=cO};var cP=function(){while(P.firstChild){var cR=P.firstChild;var cQ=cR.id.substring(ag.length+2);if(!bb[cQ]){bb[cQ]={}}bb[cQ].row=cR;if(bN[cQ]){cd.replaceChild(cR,bN[cQ].row);delete bN[cQ]}else{cd.appendChild(cR)}}};c("appendRows.render");cN();g("appendRows.render");c("appendRows.append");cP();g("appendRows.append")};var bU=function(cO){var cN=function(){P.innerHTML=cO};var cP=function(){while(P.firstChild){var cR=P.firstChild;var cQ=cR.id.substring(ag.length+2);if(bb[cQ]===undefined){bb[cQ]={}}bb[cQ].locked=cR;if(bN[cQ]!==undefined){au[0].replaceChild(cR,bN[cQ].locked)}else{au[0].appendChild(cR)}}};cN();cP()};var Z;var cx;var am;var ao=function(){if(!cA){return}c("renderRows.setup");var cN=Math.floor(bs.scrollTop()/aU);var cW=Math.ceil(cN+cB*1.5);if(cN<0){cN=0}if(cW>cA.length()){cW=cA.length()}var cX=(cW-cN)*a9;var cU=cN*aU;var cY=N.height();if(aR.is(":visible")){cY-=aR.outerHeight()-1}if(a8.is(":visible")){cY-=a8.outerHeight()-1}if(cU+cX>cY){cU=cY-cX}g("renderRows.setup");var cV=function(c0,cZ){if(!cZ[c0]){return}row=cZ[c0].row;if(row!==undefined){row.parentNode.removeChild(row)}row=cZ[c0].locked;if(row!==undefined){row.parentNode.removeChild(row)}delete cZ[c0]};c("renderRows.destroy");var cQ=cN+cA.currentBucketStart();var cO=cW+cA.currentBucketStart();for(var cT in bb){if(bC[cT]<cQ||bC[cT]>=cO){cV(cT,bb)}}for(var cT in bN){if(bC[cT]<cQ||bC[cT]>=cO){cV(cT,bN)}}var cS=_.keys(bN);for(var cP=0;cP<cS.length;cP++){var cT=cS[cP];if(h.isBlank(cA.getByID(cT))){cV(cT,bN)}}g("renderRows.destroy");Z=cU;cx=Math.round(parseFloat(bc.css("top")));var cR=function(c7){if(!h.isBlank(Z)&&Math.round(parseFloat(bc.css("top")))==Math.round(cx)){bc.css("top",Z);bc.height(cX);au.css("top",Z);au.height(cX);am=Z;Z=undefined;cx=Math.round(parseFloat(bc.css("top")))}if(Math.round(am)!=Math.round(cU)){return}var c1=[];var c2=[];var c5=[];c("renderRows.render");for(var c0=0;c0<c7.length;c0++){var c6=c7[c0];var c3=c6.id;var c4=cA.index(c6);if(bb[c3]&&(bC[c3]==c4+cQ)){h(bb[c3].row).css("top",(c4-cN)*a9);var cZ=bb[c3].locked;if(cZ!==undefined){h(cZ).css("top",(c4-cN)*a9)}}else{if(bb[c3]){c1.push(c3)}cL(c2,c4-cN,c4,c6);if(aP!=null){aP(c5,c4-cN,c6.index,c6)}bC[c3]=c4}}g("renderRows.render");for(var c0=0;c0<c1.length;c0++){cV(c1[c0],bb)}c("renderRows.appendLocked");bU(c5.join(""));g("renderRows.appendLocked");c("renderRows.append");cE(c2.join(""));g("renderRows.append");c("renderRows.rowMods");if(bI.rowMods!==null){bI.rowMods(bb)}g("renderRows.rowMods");c("renderRows.cellNav");if(cf){bv();cl()}g("renderRows.cellNav");c("renderRows.selection");if(!h.isBlank(cF)){bT(cF)}bV();g("renderRows.selection")};if(cN!=cW){cA.loadRows(cN,cW,function(cZ){cR(cZ)});cn(false)}else{cn(true)}};var bV=function(){c("rowSelection.removeSelect.inside");N.find(".blist-select-row").removeClass("blist-select-row");g("rowSelection.removeSelect.inside");c("rowSelection.removeSelect.locked");aj.find(".blist-select-row").removeClass("blist-select-row");g("rowSelection.removeSelect.locked");c("rowSelection.addSelect");_.each((cA.view.highlightTypes||{}).select,function(cO,cN){h("#"+ag+"-r"+cN).addClass("blist-select-row");h("#"+ag+"-l"+cN).addClass("blist-select-row")});g("rowSelection.addSelect");c("rowSelection.cellNav");bv();g("rowSelection.cellNav")};var bW=function(){c("initRows.handle");if(bh!=bu()){q();w();bw();cz()}g("initRows.handle");c("initRows.cleaning");au[0].innerHTML="";bc[0].innerHTML="";bb={};bN={};g("initRows.cleaning");aO()};var bZ=function(cP){cP=h.makeArray(cP);for(var cN=0;cN<cP.length;cN++){var cQ=cP[cN];var cO=cQ.id;var cR=bb[cO];if(cR){delete bb[cO];bN[cO]=cR}}aO();if(cA.dataLength()<0){cA.loadRows(0,50)}};var W=function(cN,cR){var cQ=_.isEmpty(cN);cm.css("cursor","crosshair");Y.append('<div class="disabled-overlay"></div>');var cO=0;_.each(bi,function(cY){var cV=h(cY.dom);var cX=cV.position().left;var cU="disabled-overlay";if(cQ||_.include(cN,cY.renderTypeName)){cU="select-overlay"}var cS=h('<div class="'+cU+" col-"+cY.id+'"></div>').width(cV.outerWidth()).css("left",cX).hover(function(){cS.add(cT).add(cW).addClass("overlay-hover")},function(){cS.add(cT).add(cW).removeClass("overlay-hover")});if(cQ||_.include(cN,cY.renderTypeName)){cS.click(function(){if(_.isFunction(cR)){cR(cY)}})}var cT=cS.clone(true);var cW=cS.clone(true).css("left",cX+cu);L.append(cS);bJ.append(cT);N.append(cW);cO=cV.outerWidth()+cV.position().left});var cP=h('<div class="disabled-overlay"></div>').width(L.width()-cO).css("left",cO);L.append(cP);bJ.append(cP.clone());N.append(cP.clone().css("left",cO+cu).width(cP.width()-cu))};var a2=function(){cm.css("cursor","auto");cm.find(".disabled-overlay, .select-overlay").remove()};var aK=this;var aV;af.bind("dataset_ready",function(cP,cO){cA=cO;var cQ=function(){if(!aJ){q();w();bw();cz();bW();af.bind("columns_changed",function(){q();w();bw();cz();bW()}).bind("rows_changed",function(cR){c("updateRows");bW();if(cA.usingBuckets()){cA.setRowBucket(0,"normal")}cz();g("updateRows")}).bind("selection_change",function(cR,cS){c("selectionChange");bV(cS);g("selectionChange")}).bind("show",function(){q();w();bw();cz();bW()})}aJ=true;aO();if(!h.isBlank(aV)){aV.unbind(null,null,aK)}aV=cA.view;if(h.deepGet(blist,"sidebarHidden","feed","cellFeed")===false){cA.view.getCommentLocations()}cA.view.bind("row_change",function(cR){bZ(cR)},aK).bind("query_change",cD,aK).bind("column_resized",T,aK).bind("column_totals_changed",function(){_.defer(bw)},aK)};if(cA.dataLength()<0){var cN;cN=function(){cA.loadRows(0,50,function(){cQ()},function(cR){if((cR||{}).cancelled){cN()}})};cN()}else{cQ()}});af.blistModel(bI.model);var E=false;var aH=function(){this.getSelectedColumns=function(){return cf?cf.getSelectedColumns():{}};this.disable=function(){E=true;af.addClass("disabled");O()};this.enable=function(){E=false;af.removeClass("disabled");a2()};this.enterColumnChoose=function(cN,cO){cN=h.makeArray(cN);W(cN,cO)};this.exitColumnChoose=function(){a2()};this.setCommentCell=function(cP,cN){aG[cP]=aG[cP]||{};var cO=cA.view.columnForTCID(cN).id;aG[cP][cO]=aG[cP][cO]||[];aG[cP][cO].push("comments-active");bZ([{id:cP}])};this.clearCommentCell=function(cP,cN){var cO=cA.view.columnForTCID(cN).id;if(h.isBlank(aG[cP])||h.isBlank(aG[cP][cO])){return}aG[cP][cO]=_.without(aG[cP][cO],"comments-active");bZ([{id:cP}])}};af.data("blistTableObj",new aH())};var k={cellComments:false,cellExpandEnabled:true,cellNav:false,columnDrag:false,disableLastColumnResize:false,editEnabled:false,generateHeights:true,ghostMinWidth:20,headerMods:function(n){},manualResize:false,resizeHandleAdjust:3,rowHandleRenderer:function(r,o,q,s,n,p){},rowHandleWidth:1,rowMods:function(n){},selectionEnabled:true,showGhostColumn:false,showRowNumbers:true,showRowHandle:false,showAddColumns:false};h.fn.extend({blistTable:function(n){return this.each(function(){if(!h(this).is(".blist-table")){j.apply(this,[h.extend({},k,n)])}})},blistTableAccessor:function(){return this.data("blistTableObj")}})})(jQuery);blist.namespace.fetch("blist.data");blist.data.TableNavigation=function(o,e,f){var c=o;this.updateModel=function(u){c=u};var r=e;this.updateLayout=function(u){r=u};var s=f;var t=false;var k;var n;var d;var j=-1;var g=[];var b={};this.lastSelectedColumn=null;var q=function(){if(g.length){return true}for(var u in b){return true}if(c.hasSelectedRows()){return true}return false};var i=function(){var x=[];for(var v=0;v<g.length;v++){var w=g[v];var y=w.slice(0);if(y[1]>y[3]){var u=y[3];y[3]=y[1];y[1]=u}if(y[0]>y[2]){u=y[2];y[2]=y[0];y[0]=u}x.push(y)}x.sort(function(A,z){var B=A[1]-z[1];if(B){return B}return A[3]-z[3]});return x};var h=function(u,w,C){var A=C.slice(0,C.length);for(var y=0;y<w;y++){var v=u[y];for(var x=v[0];x<=v[2];x++){A[x]=true}var B=r[j];x=v[2];var z=B[x].logical;for(x++;x<B.length&&B[x].logical==z;x++){A[x]=true}}return A};this.goTo=function(E,B,H,K,D){if(!H){H={}}var A;if(K||H.shiftKey){if(g.length){A="continue"}else{A="start"}}else{if(H.metaKey){A="start-new"}else{if(q()){g=[];b={};this.lastSelectedColumn=null}}}var w=c.get(B);var u=w!==undefined?(w.level||0):0;if(q()&&j!=u){return false}var G=r[u];var F=1;var v=G[E];var z=v.logical;if(D&&w!==undefined&&!w.expanded&&(v.renderTypeName=="opener"||v.renderTypeName=="header")){var C=c.getRowValue(w,v.mcol);if(c.useBlankRows()||C&&C.length>0){c.expand(w)}}if((w===undefined||!w.expanded||!D)&&(v.renderTypeName=="opener"||v.renderTypeName=="header")){for(var I=E+1;I<G.length&&G[I].logical==z;I++){F++}}if(w!==undefined&&w.expanded&&D&&(v.renderTypeName=="opener"||v.renderTypeName=="header")){var L=l(1,H,E,B,D);if(L){E=L.x;B=L.y;w=c.get(B);u=w.level||0;G=r[u];v=G[E];z=v.logical}}var O;if(A=="start"||A=="start-new"){if(!g.length){var N=c.get(B);j=N!==undefined?(N.level||0):0}var M=A=="start"&&t?k:E;var J=A=="start"&&t?d:B;g.push(O=[M,J])}else{if(A=="continue"){O=g[g.length-1]}}if(O){O[2]=E<O[0]?E:E+F-1;O[3]=B}t=true;k=E;n=F;d=B;return true};this.selectionInit=function(w){var u=true;if(g.length){var v=g[g.length-1];if(v[0]==w.x&&v[1]==w.y){u=false}}if(u){this.deactivate();return false}return true};this.initCopy=function(){if(q()){s.val("x");s[0].select()}else{s.val("")}};this.processSelection=function(J,u,A){return;var H=i();var y;var B;var E=[];var w;if(j==0){var G=r[j];for(var z=0;z<G.length;z++){var x=E[z]=b[G[z].mcol.id];if(x){w=true}}}var D=J.length;for(var z=0;z<D;z++){var I=J[z];var C=c.index(I);var v;if($.isBlank(C)||_.isNaN(C)){C=z;v=c.get(C)}else{v=I}if($.isBlank(v)||v.id=="blank"){continue}if($.subKeyDefined(c.view,"highlightTypes.select."+v.id)){y=[];_.each(r[v.level||0],function(L,K){y[K]=true})}else{if(!v||(v.level||0)!=j){A(I);continue}while(H.length&&H[0][3]<C){H.shift();y=undefined}for(var F=0;F<H.length;F++){if(H[F][1]>C){break}}if(F==0&&!w){A(I);continue}if(!y||B!=F){B=F;y=h(H,F,E)}}u(I,y)}};this.isActive=function(){return t};this.getActiveX=function(){return k};this.getActiveXEnd=function(){return k+n};this.getActiveWidth=function(){return n};this.getActiveY=function(){return d};this.deactivate=function(){t=false};this.clearAll=function(){var u=false;if(t){t=false;u=true}if(q()){g=[];b={};this.lastSelectedColumn=null;u=true}s.val("");return u};var a=function(v,z){var A=z!==undefined?(z.level||0):0;var y=r[A];var u=null;for(var w=0;w<y.length;w++){if(y[w].mcol==v){u=w;break}}if(u==y.length){return null}return u};var l=function(W,N,v,u,E){var D=u;if(D===undefined){return null}D+=W;var H=v;var Q=c.get(u);var X=Q!==undefined?(Q.level||0):0;var L=r[X][v];if(E&&(D<0||D>=c.length())){if(L.renderTypeName!="header"&&L.renderTypeName!="opener"&&L.mcol&&L.mcol.parentColumn&&((L.mcol.indexInLevel>0&&W<0)||(L.mcol.indexInLevel<L.mcol.parentColumn.visibleChildColumns.length-1&&W>0))){D+=(W<0?1:-1)*Q.parent.childRows.length;H+=W<0?-1:1}else{if(L.renderTypeName=="header"){for(var R=0;R<r[X].length;R++){if(r[X][R].mcol==L.mcol.parentColumn){H=R;break}}}var T=D<0?c.length()-1:0;if(L.mcol&&L.mcol.parentColumn){H=a(L.mcol.parentColumn,c.get(T));if(H===null){return null}}else{var U=c.get(T);if((U!==undefined?(U.level||0):0)>X){var I=r[X][H+(W<0?-1:1)];if(I&&I.renderTypeName=="header"&&I.mcol&&I.mcol.parentColumn){H=a(I.mcol,c.get(T));if(H===null){return null}H=H+(W<0?1:-1)}else{T=c.nextInLevel(T+(W<0?1:-1),W<0)}}}var Y=m(D<0?-1:1,N,H,T);if(Y&&(Y.x!=H||Y.y!=D)){H=Y.x;D=Y.y}}}if(D<0){D=0}if(D>=c.length()){D=c.length()-1}if(D==u&&H==v){return null}var A=c.get(D);var S=A!==undefined?(A.level||0):0;var w=r[S][H];if(E&&v==H&&L.mcol&&L.mcol.parentColumn&&Q!==undefined&&Q.parent&&(A===undefined||!A.parent||A.parent!=Q.parent)){if((L.mcol.indexInLevel==0&&W<0)||(L.mcol.indexInLevel==L.mcol.parentColumn.visibleChildColumns.length-1&&W>0)){H=a(L.mcol.parentColumn,A);if(H===null){return null}w=r[S][H]}else{var V=Q.parent.childRows;var G=c.index(W<0?V[V.length-1]:V[0]);var P=m(W<0?-1:1,N,H,G);if(P){H=P.x;D=P.y;A=c.get(D);S=A!==undefined?(A.level||0):0;w=r[S][H]}}}if(w&&(w.renderTypeName=="opener"||w.renderTypeName=="header")){if(A!==undefined&&A.expanded&&E){return l(W<0?-1:1,N,H,D,E)}else{var z=w.mcol.renderTypeName=="nested_table"?w.mcol:w.mcol.parentColumn;for(var M=0;M<r[S].length;M++){if(r[S][M].mcol==z){H=M;return{x:H,y:D}}}}}if(S!=X&&v==H){if(N.shiftKey||N.metaKey){var O=true}else{if(S>X){if(L.mcol&&L.mcol.visibleChildColumns){var B=L.mcol.visibleChildColumns[0]}else{if(L.mcol&&L.mcol.parentColumn){B=L.mcol}else{O=true}}}else{if(S<X&&L.mcol&&L.mcol.parentColumn){B=L.mcol.parentColumn}else{O=true}}}if(O){D=c.nextInLevel(u,W<0);if($.isBlank(D)){if(!E){return null}var C=W<0?c.length()-1:0;var F=m(W<0?-1:1,N,H,C);if(F&&F.x!=H){return F}return null}w=r[X][H]}else{if(B){H=a(B,A);if(H===null){return null}w=r[S][H]}else{return null}}}if(w&&w.mcol&&(w.mcol.parentColumn||w.renderTypeName=="nest-header")){var J=c.getRowValue(A,(w.renderTypeName=="nest-header"?w.mcol:w.mcol.parentColumn));if(!J){var K=W<0?-1:1;if(!E&&D+K>=c.length()){return null}return l(K,N,H,D,E)}}return{x:H,y:D}};var m=function(R,K,v,u,F){var E=u;var J=c.get(E);var T=J!==undefined?(J.level||0):0;var I=r[T];var G=v;var H=I[G];var B=H;var S=Math.abs(R);var P=R/S;for(var L=0;L<S;L++){for(var O=G+P;O>=0&&O<I.length;O+=P){var M=I[O];if(F&&B&&B.mcol&&B.mcol.parentColumn&&(!M.mcol||M.mcol.parentColumn!=B.mcol.parentColumn)){var A=P<0?-1:1;var U=O+(P<0?1:-1)*B.mcol.parentColumn.visibleChildColumns.length;var z=l(A,K,U,E);if(z){var Q=c.get(z.y);var N=c.get(E);if(T==(Q!==undefined?(Q.level||0):0)&&(N!==undefined?N.parent:undefined)==(Q!==undefined?Q.parent:undefined)){E=z.y;O=z.x;N=c.get(E);I=r[N!==undefined?(N.level||0):0];break}}}if(M.renderTypeName=="nest-header"||M.renderTypeName=="header"){continue}if(M.mcol&&M.mcol.renderTypeName=="nested_table"){var N=c.get(E);if(N!==undefined&&N.expanded){var D=c.getRowValue(N,M.mcol);if(!c.useBlankRows()&&(!D||D.length<1)){continue}}}if(M.renderTypeName=="fill"||(B&&B.mcol&&B.mcol.parentColumn&&M.mcol&&M.mcol.parentColumn&&M.mcol.parentColumn!=B.mcol.parentColumn)){var N=c.get(E);if(N===undefined){return null}var w=N.parent;if(M.mcol&&M.mcol.parentColumn&&w!==undefined&&w.expanded){var C=c.getRowValue(w,M.mcol.parentColumn);if(!c.useBlankRows()&&(!C||C.length<1)){continue}}E=c.index(w);G=a(B.mcol.parentColumn,w);if(G===null){return null}I=r[w!==undefined?(w.level||0):0];M=I[G];return m(R,K,G,E,F)}else{if(M.canFocus!==false){break}}}if(O<0||O>=I.length){if(!F){break}if(B&&B.mcol&&B.mcol.parentColumn){A=P<0?-1:1;U=O+(P<0?1:-1)*B.mcol.parentColumn.visibleChildColumns.length;z=l(A,K,U,E);if(z!==null){var Q=c.get(z.y);var N=c.get(E);if(T==(Q!==undefined?(Q.level||0):0)&&(N!==undefined?N.parent:undefined)==(Q!==undefined?Q.parent:undefined)){E=z.y;G=z.x;N=c.get(E);I=r[N!==undefined?(N.level||0):0];B=I[O];continue}}}N=c.get(E);if(N!==undefined&&N.parent){N=N.parent}E=c.nextInLevel(c.index(N),P<0);if(E==null){return null}O=O<0?I.length:-1;N=c.get(E);I=r[N!==undefined?(N.level||0):0];L--}G=O;B=I[G]}return{x:G,y:E}};var p=function(){if(!t&&c.length()&&c.columns()[0]){return{x:0,y:0}}return null};this.navigateY=function(u,w,v){var x=p();if(!x){x=l(u,w,k,d,v)}return x};this.navigateX=function(u,w,v){var x=p();if(!x){x=m(u,w,k,d,v)}if(!x||x.x==k&&x.y==d){x=null}return x};this.setColumnSelection=function(u,v){if(q()){if(j!=0){return}}else{j=0}b[u.id]=v;if(v){this.lastSelectedColumn=u}};this.isColumnSelected=function(u){return b[u.id]};this.getSelectedColumns=function(){var u={};_.each(b,function(w,v){if(w){u[v]=w}});return u};this.clearColumnSelection=function(){b={};this.lastSelectedColumn=null};this.getSelectionDoc=function(){var y=[];var v={rawDoc:y};if(!q()){if(t){var z=c.get(d);var u=c.columns()[k];if(z!==undefined&&u!==undefined&&!$.isBlank(u.lookup)){var w=u.renderType||blist.datatypes.text;v.row=z;var x=w.renderer(z.data[u.lookup],u,true);if(x!=undefined){return x}}}return""}return""};return this};(function(g){g.fn.scrollable=function(i){var j=g.extend({},g.fn.scrollable.defaults,i);return this.each(function(){var n=g(this);var k=g.meta?g.extend({},j,n.data()):j;n.data("config-scrollable",k);if(n.children(k.selector).length<=k.numVisible){n.find(k.prevSelector).parent().hide();n.find(k.nextSelector).parent().hide();return}n.children(k.selector+":gt("+(k.numVisible-1)+")").addClass(k.hiddenClass);f(n);var o;var l=function(q,p){if(!q()){g(document).unbind("mouseup.scrollable.repeatScroll");return}o=setTimeout(function(){l(q,p++)},Math.max(100-p*2,5))};n.find(k.prevSelector).mousedown(function(p){if(!b(n)){return}o=setTimeout(function(){l(function(){return b(n)},0)},800);g(document).bind("mouseup.scrollable.repeatScroll",function(q){clearTimeout(o);g(document).unbind("mouseup.scrollable.repeatScroll")})});n.find(k.prevSelector).click(function(p){p.stopPropagation();p.preventDefault()});n.find(k.nextSelector).mousedown(function(p){if(!a(n)){return}o=setTimeout(function(){l(function(){return a(n)},0)},500);g(document).bind("mouseup.scrollable.repeatScroll",function(q){clearTimeout(o);g(document).unbind("mouseup.scrollable.repeatScroll")})});n.find(k.nextSelector).click(function(p){p.stopPropagation();p.preventDefault()});var m=n.find(k.activeSelector+":first");while(m.length>0&&m.hasClass(k.hiddenClass)){a(n)}})};function b(j){var i=j.data("config-scrollable");var k=h(j);if(k.length>0){k.removeClass(i.hiddenClass);c(j).addClass(i.hiddenClass);f(j);return true}return false}function a(j){var i=j.data("config-scrollable");var k=e(j);if(k.length>0){k.removeClass(i.hiddenClass);d(j).addClass(i.hiddenClass);f(j);return true}return false}function h(j){var i=j.data("config-scrollable");return d(j).prev(i.selector)}function d(j){var i=j.data("config-scrollable");return j.children(i.selector+":not(."+i.hiddenClass+"):first")}function c(j){var i=j.data("config-scrollable");return j.children(i.selector+":not(."+i.hiddenClass+"):last")}function e(j){var i=j.data("config-scrollable");return c(j).next(i.selector)}function f(j){var i=j.data("config-scrollable");if(h(j).length>0){j.find(i.prevSelector).parent().removeClass(i.disabledClass)}else{j.find(i.prevSelector).parent().addClass(i.disabledClass)}if(e(j).length>0){j.find(i.nextSelector).parent().removeClass(i.disabledClass)}else{j.find(i.nextSelector).parent().addClass(i.disabledClass)}}g.fn.scrollable.defaults={activeSelector:".active",selector:".scrollable",hiddenClass:"hidden",prevSelector:".prev a",nextSelector:".next a",disabledClass:"disabled",numVisible:6}})(jQuery);(function(d){d.fn.columnMenu=function(j){var k=d(this[0]).data("columnMenu");if(!k){k=new c(j,this[0])}return k};var c=function(j,k){this.settings=d.extend({},c.defaults,j);this.currentDom=k;this.init()};d.extend(c,{defaults:{column:null,$menuTrigger:null,selectedColumns:null,$tipItem:null,view:null},prototype:{init:function(){var q=this;var s=q.$dom();s.data("columnMenu",q);if(d.isBlank(q.settings.$menuTrigger)){q.settings.$menuTrigger=s}if(d.isBlank(q.settings.$tipItem)){q.settings.$tipItem=s}var l=q.settings.column;var n=!d.isBlank(l.parentColumn);var k={};if(!n&&l.renderType.sortable){k.sort=true}if(b(q,l)){k.filter=true}var t=q.settings.view.metadata.jsonQuery.group;var o=q.settings.view.hasRight(blist.rights.view.UPDATE_COLUMN);var r=q.settings.columnDeleteEnabled;var p=l.renderType.deleteable||(blist.dataset.newBackend&&l.renderType.nbeModifiable);var j=!q.settings.view.isGrouped();var m=j||!_.any(t,function(u){return u.columnFieldName==l.fieldName});if(r&&p&&m){k.remove=true}if(q.settings.columnHideEnabled){k.hide=true}if(q.settings.columnPropertiesEnabled&&o){k.properties=true}s.addClass("hasColumnMenu");s.one("mouseover",function(){if(s.find("ul.menu").length>0){return}var u={tagName:"ul","class":["menu","columnHeaderMenu","action-item"],id:"column-menu",contents:[]};if(k.sort){u.contents.push({tagName:"li","class":["sortAsc","singleItem"],contents:{tagName:"a",href:"#column-sort-asc",contents:{tagName:"span","class":"highlight",contents:d.t("controls.grid.sort_ascending")}}},{tagName:"li","class":["sortDesc","singleItem"],contents:{tagName:"a",href:"#column-sort-desc",contents:{tagName:"span","class":"highlight",contents:d.t("controls.grid.sort_descending")}}},{tagName:"li","class":["sortClear","singleItem"],contents:{tagName:"a",href:"#column-sort-clear",contents:{tagName:"span","class":"highlight",contents:d.t("controls.grid.clear_sort")}}})}if(k.sort||k.filter){u.contents.push({tagName:"li","class":["filterSeparator","separator","singleItem",{value:"hide",onlyIf:!(k.hide||k.remove||k.properties)}]})}if(k.hide){u.contents.push({tagName:"li","class":"hideCol",contents:{tagName:"a",href:"#hide-column",contents:{tagName:"span","class":"highlight",contents:d.t("controls.grid.hide_column")}}})}if(k.remove){u.contents.push({tagName:"li","class":"delete",contents:{tagName:"a",href:"#delete-column",contents:{tagName:"span","class":"highlight",contents:d.t("controls.grid.delete_column")}}})}if(k.properties){u.contents.push({tagName:"li","class":["separator","singleItem"]},{tagName:"li","class":["properties","singleItem"],contents:{tagName:"a",href:"#edit-column",contents:{tagName:"span","class":"highlight",contents:d.t("controls.grid.edit_column_properties")}}})}u.contents.push({tagName:"li","class":"footer",contents:{tagName:"div","class":"outerWrapper",contents:{tagName:"div","class":"innerWrapper",contents:{tagName:"span","class":"colorWrapper"}}}});s.append(d.tag(u));q.$menu=s.find("ul.columnHeaderMenu");g(q)})},$dom:function(){if(!this._$dom){this._$dom=d(this.currentDom)}return this._$dom},sort:function(j){var m=this;var l=d.extend(true,{},m.settings.view.metadata);var k=l.jsonQuery;if(d.isBlank(j)){k.order=_.reject(k.order||[],function(n){return n.columnFieldName==m.settings.column.fieldName});if(k.order.length==0){delete k.order}}else{k.order=[{columnFieldName:m.settings.column.fieldName,ascending:j}]}m.settings.view.update({metadata:l},false,(k.order||[]).length<2)},clearFilter:function(){var j=this;if(j.settings.$tipItem.isSocrataTip()){j.settings.$tipItem.socrataTip().hide()}j.settings.column.clearFilter()}}});var b=function(l,j){var k=[j.renderType].concat(_.values(j.renderType.subColumns||{}));return d.isBlank(j.parentColumn)&&!l.settings.view.isGrouped()&&_.any(k,function(m){return d.subKeyDefined(m,"filterConditions.details.EQUALS")})};var g=function(j){j.$menu.dropdownMenu({triggerButton:j.settings.$menuTrigger,openCallback:function(){e(j)},linkCallback:function(k){a(j,k)},forcePosition:true,pullToTop:true}).find(".autofilter ul.menu").scrollable()};var e=function(l){if(l.settings.$tipItem.isSocrataTip()){l.settings.$tipItem.socrataTip().hide()}var m={};if(_.isFunction(l.settings.selectedColumns)){m=l.settings.selectedColumns()}var k=_.size(m);var j=l.settings.column;if(k<1||(k==1&&!d.isBlank(m[j.id]))){l.$menu.find(".singleItem").show();i(l);l.$menu.find(".sortAsc").toggle(!j.sortAscending);l.$menu.find(".sortDesc").toggle(d.isBlank(j.sortAscending)||j.sortAscending);l.$menu.find(".sortClear").toggle(!d.isBlank(j.sortAscending))}else{l.$menu.find(".singleItem").hide()}};var i=function(k){if(!b(k,k.settings.column)){return}k.$menu.children(".autofilter").prev(".separator").andSelf().remove();var j=d.tag({tagName:"li","class":["autofilter","loading"]});var l=k.$menu.find("li.filterSeparator");if(l.length>0){l.before(j)}else{k.$menu.prepend(j)}_.defer(function(){k.settings.column.getSummary(function(m){f(k,m)})})};var f=function(p,k){var j=p.settings.column;p.$menu.children(".autofilter.loading").remove();p.$menu.children(".autofilter").prev(".separator").andSelf().remove();if(d.isBlank(p.settings.column.currentFilter)&&d.isBlank(k)){return}var o={tagName:"li","class":["autofilter","submenu","singleItem"],contents:[{tagName:"a","class":"submenuLink",href:"#",contents:{tagName:"span","class":"highlight",contents:d.t("controls.grid.filter_this_column")}}]};var m={tagName:"ul","class":["menu","optionMenu"],contents:[]};o.contents.push(m);if(!d.isBlank(p.settings.column.currentFilter)){m.contents.push({tagName:"li","class":"clearFilter",contents:{tagName:"a",href:"#clear-filter-column",contents:{tagName:"span","class":"highlight",contents:d.t("controls.grid.clear_column_filter")}}});if(d.isBlank(k)){k={curVal:{topFrequencies:[{value:j.currentFilter.value,count:0}]}}}}m.contents.push({tagName:"li","class":["button","prev"],contents:{tagName:"a",href:"#pref",title:d.t("controls.grid.previous"),contents:{tagName:"div","class":"outerWrapper",contents:{tagName:"div","class":"midWrapper",contents:{tagName:"span","class":"innerWrapper",contents:d.t("controls.grid.previous")}}}}});var l=_.keys(k);if(p.settings.column.renderTypeName=="url"){l.sort()}else{if(p.settings.column.renderTypeName=="phone"){l.sort().reverse()}}var n=[];_.each(l,function(s){var v=k[s];var t=p.settings.column.renderType;var u=false;if(d.subKeyDefined(t,"subColumns."+v.subColumnType)){t=t.subColumns[v.subColumnType];u=true}var r=[];var w=function(z,y){var A=z.titleValue.toUpperCase();var x=y.titleValue.toUpperCase();return A>x?1:A<x?-1:0};if(v.subColumnType=="number"||v.subColumnType=="money"||v.subColumnType=="date"||v.subColumnType=="percent"){w=function(y,x){return y.value-x.value}}if(!d.isBlank(v.topFrequencies)){_.each(v.topFrequencies,function(x){x.isMatching=!d.isBlank(p.settings.column.currentFilter)&&p.settings.column.currentFilter.value==x.value;x.escapedValue=escape(_.isFunction(t.filterValue)?t.filterValue(x.value):d.htmlStrip(x.value+""));x.renderedValue=t.renderer(x.value,p.settings.column,false,true);x.titleValue=d.htmlStrip(x.renderedValue+"")});v.topFrequencies.sort(w);_.each(v.topFrequencies,function(x){if(x.renderedValue===""){return true}r.push({tagName:"li","class":["filterItem","scrollable",{value:"active",onlyIf:x.isMatching}],contents:{tagName:"a",href:(x.isMatching?"#clear-filter-column_":"#filter-column_")+(u?v.subColumnType:"")+":"+x.escapedValue+"|",title:x.titleValue,"class":"clipText",contents:x.renderedValue}})})}if(n.length>0){n.push({tagName:"li","class":["separator","scrollable"]})}n=n.concat(r)});m.contents=m.contents.concat(n);m.contents.push({tagName:"li","class":["button","next"],contents:{tagName:"a",href:"#next",title:"Next",contents:{tagName:"div","class":"outerWrapper",contents:{tagName:"div","class":"midWrapper",contents:{tagName:"span","class":"innerWrapper",contents:"Next"}}}}});m.contents.push({tagName:"li","class":"footer",contents:{tagName:"div","class":"outerWrapper",contents:{tagName:"div","class":"innerWrapper",contents:{tagName:"span","class":"colorWrapper"}}}});var q=p.$menu.find("li.filterSeparator");if(q.length>0){q.before(d.tag([{tagName:"li","class":["separator","singleItem"]},o]))}else{p.$menu.prepend(d.tag(o))}g(p)};var a=function(n,k){k.preventDefault();var j=d.hashHref(d(k.currentTarget).attr("href")).split("_");var m=j[0];switch(m){case"column-sort-asc":n.sort(true);break;case"column-sort-desc":n.sort(false);break;case"column-sort-clear":n.sort(null);break;case"filter-column":var o=j.slice(1).join("_").split(":");n.settings.column.filter(unescape(o.slice(1).join(":").slice(0,-1)),o[0]);break;case"clear-filter-column":n.clearFilter();break;case"hide-column":if(!d.isBlank(n.settings.column.parentColumn)){n.settings.column.hide()}else{var l={};if(_.isFunction(n.settings.selectedColumns)){l=n.settings.selectedColumns()}l[n.settings.column.id]=true;_.each(l,function(p,r){n.settings.view.columnForID(r).hide();n.settings.view.trigger("columns_changed")})}break;case"delete-column":if(!d.isBlank(n.settings.column.parentColumn)){h(n)}else{var q={};if(_.isFunction(n.settings.selectedColumns)){q=n.settings.selectedColumns()}q[n.settings.column.id]=true;h(n,_.keys(q))}break;case"edit-column":n.settings.editColumnCallback(n.settings.column);break}};var h=function(l,k){k=d.makeArray(k);var j=k.length>1;if(confirm(j?d.t("controls.grid.delete_warning_multi_column"):d.t("controls.grid.delete_warning_single_column"))){if(_.isEmpty(k)&&!d.isBlank(l.settings.column.parentColumn)){l.settings.column.parentColumn.removeChildColumns(l.settings.column.id)}else{if(_.isEmpty(k)){k=[l.settings.column.id]}l.settings.view.removeColumns(k)}}}})(jQuery);var datasetControlsNS=blist.namespace.fetch("blist.datasetControls");blist.datasetControls.hookUpShareMenu=function(f,b,h,g){var c=f.displayType==="story"?"share_story_text":"share_text";var d=escape($.t("controls.common.share."+c,{name:f.name,site:blist.configuration.strings.company}));var i=f.fullUrl;var e=f.shortUrl;var a={menuButtonContents:$.t("controls.common.share.button_prompt"),menuButtonTitle:$.t("controls.common.share.button_tooltip"),contents:[{text:$.t("controls.common.share.networks.facebook"),className:"facebook",rel:"external",href:"http://www.facebook.com/share.php?u="+i},{text:$.t("controls.common.share.networks.twitter"),className:"twitter",rel:"external",href:"http://twitter.com/?status="+d+e},{text:$.t("controls.common.share.networks.email"),className:"email",href:"#email",onlyIf:!g}]};$.extend(a,h);b.menu(a)};blist.datasetControls.unsavedViewPrompt=function(){$("a").on("click",function(h){if(!blist.dataset.temporary||blist.dataset.minorChange){return}if(h.ctrlKey||h.metaKey){return}var b=h.currentTarget;if(b.rel.indexOf("external")>-1){return}if(b.className.indexOf("noRedirPrompt")>-1){return}var d=b.href;if($.isBlank(d)){return}var c=d;var f=window.location.href;if(f.endsWith("#")){f=f.slice(0,-1)}if(window.location.hash.length>0){f=f.slice(0,-window.location.hash.length)}if(d.startsWith(f)){c=d.slice(f.length)}if(c.charAt(0)=="#"){return}if(window.location.href==d){return}h.preventDefault();var g=function(){window.location=d;return true};datasetControlsNS.showSaveViewDialog("leavingSaveDialog",g,g)})};blist.datasetControls.showSaveViewDialog=function(h,f,e,i,c){var a=datasetControlsNS.showSaveViewDialog;var d=$(".saveViewDialog");d.find(".mainError").text("");d.jqmShow();a._customClass=h;if(!$.isBlank(a._customClass)){d.addClass(a._customClass)}var b=function(){setTimeout(function(){if(!$.isBlank(a._customClass)){d.removeClass(a._customClass)}d.find(".viewName").val("")},1000)};d.loadingSpinner({metric:"save",overlay:true});a._saveCallback=f;a._dontSaveCallback=e;a._cancelCallback=i;var g=function(j){var n=d.find(".viewName");var k=n.val();if(j&&$.isBlank(k)){d.find(".mainError").text($.t("screens.ds.save_dialog.validation.view_name_required"));return}d.find(".mainError").text("");var m=function(){d.loadingSpinner().showHide(true);var o=blist.dataset.newBackend;var q=function(s){d.loadingSpinner().showHide(false);var r=false;if(_.isFunction(a._saveCallback)){r=a._saveCallback(s)}if(!r){s.redirectTo()}else{b();d.jqmHide()}};var p=function(r){d.loadingSpinner().showHide(false);d.find(".mainError").text(JSON.parse(r.responseText).message)};if(!$.isBlank(c)){blist.dataset.update(c)}if(j){blist.dataset.name=k;blist.dataset.saveNew(o,q,p)}else{blist.dataset.save(q,p)}};if(!$.isBlank(blist.util.inlineLogin)){var l=$.t("screens.ds.save_dialog.validation.auth_required");blist.util.inlineLogin.verifyUser(function(o){if(o){m()}else{d.find(".mainError").text(l)}},l)}else{m()}};if($.isBlank(a._hookedEvents)){d.find("form").submit(function(j){j.preventDefault();g(true)});d.find("a.save").click(function(j){j.preventDefault();g(d.find(".viewName").is(":visible"))});d.find("a.update").click(function(j){j.preventDefault();g(false)});d.find(".jqmClose").click(function(){b();if(_.isFunction(a._cancelCallback)){a._cancelCallback()}});d.find(".dontSave").click(function(){if(_.isFunction(a._dontSaveCallback)){a._dontSaveCallback()}});a._hookedEvents=true}};blist.datasetControls.datasetRating=function(b,d,a){if(!a&&!$.isBlank(b.data("rating-type"))&&$.isBlank(b.data("rating"))){var c=b.closest("dd").addClass("hide");c.prev("dt").addClass("hide");return}b.stars({onChange:function(e){blist.util.doAuthedAction($.t("controls.common.rate.auth_action_phrase"),function(f){blist.dataset.updateRating({type:b.attr("data-rating-type"),rating:(e*20)},function(g){if(!_.isUndefined(g.type)){d.find(".totalTimesRated").text(parseInt($.trim(d.find(".totalTimesRated").text()))+1)}b.attr("title","");if(_.isFunction(f)){f()}})})}})};blist.datasetControls.datasetContact=function(c){var a=function(){var d=c.find("#contactPurpose");var f=d.val();var e="";if($.isBlank(f)){return}if(f=="other"){e=$.t("screens.ds.dataset_contact.other_subject",{dataset_name:blist.dataset.name,site:blist.configuration.strings.company})}else{e=$.t("screens.ds.dataset_contact.subject",{dataset_name:blist.dataset.name,reason:$.t("screens.ds.dataset_contact.reasons."+f)})}c.find("#contactSubject").val(e);c.find("#contactBody").focus()};var b=function(){c.find(".contactOwnerForm").slideToggle().find("#contactBody").focus().end().end().find(".contactOwnerLinks").slideToggle().end()};c.delegate(".contactButton","click",function(g){g.preventDefault();var h=$(this);c.find(".flash").removeClass("notice").text("").fadeOut();if($.subKeyDefined(blist,"datasetPage.sidebar")&&blist.datasetPage.sidebar.$dom().width()<350){blist.datasetPage.sidebar.$dom().width(350);$(window).resize()}if(c.find(".contactOwnerForm").length===0){h.closest(".formSection").after($.renderTemplate("aboutDataset_contact"));blist.util.loadCaptcha("contactCaptcha");var e=c.find(".contactOwnerForm").addClass("sectionContent");e.parent().addClass("formSection");e.validate({rules:{type:"required",subject:"required",message:"required",from_address:{required:true,email:true}},messages:{type:$.t("screens.ds.dataset_contact.validation.no_purpose"),subject:$.t("screens.ds.dataset_contact.validation.no_subject"),message:$.t("screens.ds.dataset_contact.validation.no_body"),from_address:{required:$.t("screens.ds.dataset_contact.validation.no_email")}},errorPlacement:function(j,k){j.appendTo(k.closest(".lined"))}});var d=c.find("#contactPurpose").change(a);if(!d.parent().hasClass("uniform")){d.uniform()}e.submit(function(j){j.preventDefault();if(e.valid()){$.ajax({url:e.attr("action"),data:e.serialize(),type:"POST",dataType:"json",error:function(){c.find(".flash:not(.recaptcha_flash)").removeClass("notice").addClass("error").text($.t("screens.ds.dataset_contact.error_message")).show()},success:function(k){if(k.success==true){_.defer(function(){c.find(".flash:not(.recaptcha_flash)").removeClass("error").addClass("notice").text($.t("screens.ds.dataset_contact.success_message")).show();b()});c.find(".recaptcha_flash").removeClass("error").fadeOut()}else{if(k.success==false){c.find(".recaptcha_flash").removeClass("notice").addClass("error").text($.t("recaptcha.errors.verification_failed")).fadeIn()}}}})}});c.find(".sendContactButton").click(function(j){j.preventDefault();e.submit()})}var f=c.find(".contactOwnerForm");f[0].reset();f.validate().resetForm();b();if(!_.isUndefined(h.attr("data-select"))){var i=c.find("#contactPurpose");i.val(h.attr("data-select"));a();$.uniform.update(i)}})};blist.datasetControls.getColumnTip=function(a){return'<div class="blist-th-tooltip '+a.renderTypeName+'"><p class="name">'+$.htmlEscape(a.name).replace(/ /,"&nbsp;")+"</p>"+(!$.isBlank(a.metadata.originalName)?'<p class="originalName"><span class="title">'+$.t("screens.ds.column_tip.original_name")+':</span> <span class="value">'+$.htmlEscape(a.metadata.originalName).replace(/ /,"&nbsp;")+"</span>":"")+(a.description!==undefined?'<p class="description">'+$.htmlEscape(a.description)+"</p>":"")+'<p class="columnType"><span class="blist-th-icon"></span>'+$.t("core.data_types."+a.dataTypeName)+(a.format.grouping_aggregate!==undefined?" "+$.t("screens.ds.column_tip.aggregate",{aggregate:$.t("core.aggregates."+a.format.grouping_aggregate),data_type:$.t("core.data_types."+a.dataTypeName)}):"")+"</p>"+(a.fieldName!==undefined?'<br/><p class="api-field">'+$.t("screens.ds.column_tip.field_name")+": "+$.htmlEscape(a.fieldName)+"</p>":"")+"</div>"};blist.datasetControls.raReasonBox=function(a){var d=a.siblings("input");var c=a.children("textarea");a.addClass("hide jsEnabled");a.append(a.siblings(".button").clone());a.append($.tag({tagName:"a",href:"#Close","class":"remove",contents:{tagName:"span","class":"icon"}}));a.closest("form").validate();var b=function(){a.addClass("hide");a.closest("form").css("z-index","");c.blur()};c.keydown(function(f){if(f.which==27){b()}});a.find(".remove").click(function(f){f.preventDefault();b()});d.click(function(f){if(a.hasClass("hide")){f.preventDefault();a.removeClass("hide");a.closest("form").css("z-index",10);c.focus()}})};blist.datasetControls.editPublishedMessage=function(){var g="editPublishedMessage"+_.uniqueId();var f=$.tag({tagName:"div","class":"editPublishedMessage",id:g,contents:{tagName:"div","class":"throbber"}});var e=true;var c=function(l,j){var n=blist.datasetControls.copyPending||j;var i=$("#"+g);if(i.length===0){i=f}if((i.length===0)||(!e&&(i.closest("body").length===0))){return}if(i.find(".doneCopyingMessage").is(":visible")){return}i.empty().append($.renderTemplate("editAlertTemplate",l,{".editPublished@class+":function(){return n?"hide":""},".editMessage":function(){return d(l)},".editMessage@class+":function(){return n?"hide":""},".copyingMessage":function(){return $.t("screens.ds.dataset_status.copy_in_progress",{additional:l.message})},".copyingMessage@class+":function(){return n?"":"hide"}}));var k=i.closest(".bt-wrapper");if(k.length>0){var h=k.data("socrataTip-$element");var m=h.data("socrataTip");m.refreshSize()}if(!blist.dataset._unpublishedView){window.setTimeout(function(){a()},30000)}e=false};var d=function(h){if(blist.dataset.isImmutable()){return $.t("screens.ds.dataset_status.immutable")}else{return $.t("screens.ds.dataset_status.needs_copy",{status:$.t("screens.ds.dataset_status.needs_copy_status."+h.status)})}};var b=false;var a=function(){blist.dataset.getOperationStatuses(function(j){var k={};var i=false;var h=function(l){return blist.util.humaneDate.getFromDate(new Date(l*1000))};switch(j.copying.copyStatus){case"finished":k.status=b?"available":"can_be_made";break;case"queued":k.message=$.t("screens.ds.dataset_status.copy_in_progress_additional.queued",{time:h(j.copying.queuedAt),totalQueued:j.copying.totalQueued});i=true;break;case"processing":k.message=$.t("screens.ds.dataset_status.copy_in_progress_additional.processing",{time:h(j.copying.startedAt)});i=true;break;case"failed":k.status="can_be_made"}b=b||i;c(k,i)})};blist.dataset.getUnpublishedDataset(function(h){if($.isBlank(h)){a()}else{c({status:"available"},false)}});return f};blist.datasetControls.hookUpPublishing=function(a){a.find(".unpublished").socrataTitleTip();a.find(".snapshotted").socrataTitleTip();a.find(".publish").click(function(b){b.preventDefault();if($(b.target).hasClass("disabled")){return}blist.dataset.publish(function(c){c.redirectTo()},function(d){var c=$.t("screens.ds.dataset_status.error_publishing_html");if((JSON.parse((d||{}).responseText)||{}).message=="Only unpublished datasets can be published."){c=$.t("screens.ds.dataset_status.error_publishing_unpublished")}a.find("#datasetName").socrataTip({content:$.tag({tagName:"p","class":"errorMessage",contents:c}),showSpike:false,trigger:"now"})})});if(a.find(".publish").exists()){blist.dataset.getPublishingAvailable(function(d,b){var c=a.find(".publish");if(!d){c.addClass("disabled").attr("title",b)}c.socrataTitleTip()})}if(!blist.dataset.isPublished()){blist.dataset.getPublishedDataset(function(b){if(!$.isBlank(b)){a.find("#publishedLink").attr("href",b.url).find(".publishedName").text(b.name)}else{a.find("#publishedLink").hide()}})}};(function(e){e.fn.isDatasetGrid=function(){return !_.isUndefined(e(this[0]).data("datasetGrid"))};e.fn.datasetGrid=function(s){var t=e(this[0]).data("datasetGrid");if(!t){t=new e.datasetGridObject(s,this[0])}return t};e.datasetGridObject=function(s,t){this.settings=e.extend({},e.datasetGridObject.defaults,s);this.currentGrid=t;this.init()};e.extend(e.datasetGridObject,{defaults:{addColumnCallback:function(s){},columnDeleteEnabled:false,columnHideEnabled:true,columnNameEdit:false,columnPropertiesEnabled:false,editColumnCallback:function(s,t){},editEnabled:true,manualResize:false,showRowHandle:false,showRowNumbers:true,showAddColumns:false,view:null},prototype:{init:function(){var s=this;var t=s.$dom();t.data("datasetGrid",s);s.settings._filterCount=0;t.bind("column_sort",function(v,w,u){b(s,w,u)}).bind("clear_filter",function(u,v){j(s,v)}).bind("column_moved",function(u,w,v){q(s,w,v)}).bind("column_name_dblclick",function(v,u){k(s,v,u)}).bind("cellclick",function(v,u,x,w){o(s,v,u,x,w)}).bind("comment_click",function(w,v,u){g(s,v,u)}).blistTable({cellNav:true,selectionEnabled:false,generateHeights:false,columnDrag:true,editEnabled:s.settings.editEnabled,headerMods:function(u){p(s,u)},rowMods:function(u){m(s,u)},manualResize:s.settings.manualResize,showGhostColumn:true,cellComments:_.isFunction(s.settings.cellCommentsCallback),showRowHandle:s.settings.showRowHandle,rowHandleWidth:15,showAddColumns:s.settings.showAddColumns,rowHandleRenderer:function(){return s.rowHandleRenderer.apply(s,arguments)},showRowNumbers:s.settings.showRowNumbers}).blistModel().options({blankRow:s.settings.editEnabled,filterMinChars:0});e.live("#"+t.attr("id")+" .blist-table-row-handle","mouseover",function(u){i(s,this,u)});e.live("#"+t.attr("id")+" .add-column","click",function(){s.settings.addColumnCallback()});if(e.device.mobile){e.live("#"+t.attr("id")+" .drillDown","touchend",function(){s.drillDown(this)})}e.live("#"+t.attr("id")+" .drillDown","click",function(u){u.preventDefault();s.drillDown(this)});e.live("#"+t.attr("id")+" .blist-table-row-numbers a","click",function(u){n(s,u)});s._model=t.blistModel();s.setView(s.settings.view);e(document).bind("cell_feed_shown",function(w,v,u){e(s.currentGrid).blistTableAccessor().setCommentCell(v,u)});e(document).bind("cell_feed_hidden",function(w,v,u){e(s.currentGrid).blistTableAccessor().clearCommentCell(v,u)})},$dom:function(){if(!this._$dom){this._$dom=e(this.currentGrid)}return this._$dom},setView:function(t){if(this._view){this._view.unbind("grid_error_message")}this._view=t;this._model.options({view:t});var s=this.$dom();this._view.bind("grid_error_message",function(u,v,w){e('.blist-tr[id$="r'+u.id+'"] .blist-td[class*="c'+v.id+'"]',s).socrataTip({trigger:"now",isSolo:true,message:w,parent:"body"})})},isValid:function(){return !e.isBlank(this._view)},drillDown:function(C){var E=this;var x=e(C);var D=x.attr("cellvalue");var z=E._view.columnForIdentifier(x.attr("column"));if(e.isBlank(z)||D==""){return false}var G=E._view.cleanCopy();var v;var t={columnFieldName:z.fieldName,subColumn:z.renderTypeName};if(D=="null"||D=="undefined"){v=e.extend({operator:"IS_BLANK"},t)}else{if(!e.isBlank(z.format.group_function)&&z.format.group_function.startsWith("date_")){var u=z.format.group_function;var s=!e.isBlank(z.renderType.stringParse)?Date.parseExact(D,z.renderType.stringParse):new Date(parseInt(D)*1000);if(s.getHours()!=0){s.setMinutes(s.getMinutes()+s.getTimezoneOffset())}var A=s.clone();s.setSeconds(-1);if(u.endsWith("_y")){A.setYear(A.getFullYear()+1)}if(u.endsWith("_ym")){A.setMonth(A.getMonth()+1)}else{if(u.endsWith("_ymd")){A.setHours(24)}}s=!e.isBlank(z.renderType.stringFormat)?s.toString(z.renderType.stringFormat):s.getTime()/1000;A=!e.isBlank(z.renderType.stringFormat)?A.toString(z.renderType.stringFormat):A.getTime()/1000;v={operator:"AND",children:[e.extend({operator:"GREATER_THAN",value:z.renderType.filterValue(s)},t),e.extend({operator:"LESS_THAN",value:z.renderType.filterValue(A)},t)]}}else{v=e.extend({operator:"EQUALS",value:e.unescapeQuotes(D)},t)}}G.metadata.jsonQuery.namedFilters=G.metadata.jsonQuery.namedFilters||{};G.metadata.jsonQuery.namedFilters["drillDown-"+z.fieldName]={where:v};var I=function(J){E._view.update(J,true)};var w=_.select(G.metadata.jsonQuery.group||[],function(J){return J.columnFieldName!=z.fieldName});if(w.length>0){_.each(G.columns,function(J){if(J.fieldName==z.fieldName){if(!J.flags){J.flags=[]}J.flags.push("hidden");delete J.format.grouping_aggregate;delete J.format.drill_down;if(!e.isBlank(J.format.group_function)){delete J.format.group_function;J.format.view=Column.closestViewFormat(z,J)}}});G.metadata.jsonQuery.group=w;I(G)}else{var y,F;G.metadata.jsonQuery.select=[];var B=function(K,J){return _.detect(J,function(L){return L.tableColumnId==K.tableColumnId})};var H=function(){var J=[];_.each(F,function(L){var K=B(L,y);if(!e.isBlank(K)){var M=L.cleanCopy();M.id=K.id;if(!e.isBlank(M.childColumns)){var N=[];_.each(L.childColumns,function(O){var P=O.cleanCopy();P.id=B(O,K.childColumns).id;N.push(P)});M.childColumns=N}if(!e.isBlank(M.format)){delete M.format.grouping_aggregate;delete M.format.drill_down;if(!e.isBlank(M.format.group_function)){delete M.format.group_function;M.format.view=Column.closestViewFormat(z,M)}}J.push(M)}});G.columns=J;I(G)};delete G.metadata.jsonQuery.group;y=E._view.realColumns;if(E._view.type=="blist"){F=E._view.realColumns}if(!_.isUndefined(F)){H()}if(E._view.type!="blist"){E._view.getParentDataset(function(J){if(!e.isBlank(J)){F=J.realColumns;H()}else{F=E._view.realColumns;H()}})}}},disable:function(){var s=this;if(s._disabled){return}s._disabled=true;s.$dom().blistTableAccessor().disable()},enable:function(){var s=this;if(!s._disabled){return}s.$dom().blistTableAccessor().enable();delete s._disabled},rowHandleRenderer:function(v,y,w,A,u,s){var t=!e.isBlank((u||{}).childColumns);var x=t?("_"+u.lookup):"";var z=[];if(!t){z.push('<li class="pageView"><a href="',this._view.url,"/",A.id,'" class="noInterstitial noRedirPrompt">'+e.t("controls.grid.view_single_row")+"</a></li>")}if(this.settings.editEnabled&&s.permissions.canDelete){z.push('<li class="delete"><a href="#row-delete#',A.id,x,'">'+e.t("controls.grid.delete_row")+"</a></li>")}if(_.isEmpty(z)||A.type=="blank"){return}v.push('<a class="menuLink" href="#row-menu#',A.id,x,'"></a>','<ul class="menu rowMenu" id="row-menu_',A.id,x,'">',z.join(""),'<li class="footer"><div class="outerWrapper">','<div class="innerWrapper"><span class="colorWrapper"></span></div>',"</div></li></ul>")}}});var i=function(s,w,v){var u=e(w);if(!u.data("row-menu-applied")){var t=u.find("ul.menu");t.dropdownMenu({menuContainerSelector:".blist-table-row-handle",triggerButtonSelector:"a.menuLink",openCallback:function(x){h(s,x)},linkCallback:function(x){n(s,x)},pullToTop:true});$menuLink=u.find(".menuLink");u.data("row-menu-applied",true)}};var h=function(s,t){};var n=function(C,u){u.preventDefault();var B=e(u.currentTarget);var v=B.attr("href");var y=v.indexOf("#");var z;var x;if(y<0&&(!e.isBlank(v.match(/\/\d+$/))||!e.isBlank(v.match(/\/row-/)))){z="view-row";x=v.slice(v.lastIndexOf("/")+1)}else{var E=v.slice(y+1).split("#");if(E.length<2){return}z=E[0];x=E[1];if(!x.match(/row-(?:[a-z0-9]{4}[-_~\.]){2}[a-z0-9]{4}/)){var D=x.split("_");x=D[0];if(D[1]){E.push(D[1])}}}var t=B.closest(".rowMenu");var A=C._model;switch(z){case"row-delete":if(!e.isBlank(E[2])){var w=C._view.columnForID(E[2]);A.removeChildRows(A.getByID(x),w)}else{A.removeRows(x)}break;case"view-row":e(document).trigger(blist.events.DISPLAY_ROW,[x]);break}};var o=function(t,w,x,v,s){var u=t._model;if(x.level>0){return}if(e.isBlank(v)||v.id=="rowNumberCol"){if(s.shiftKey){u.selectRowsTo(x)}else{u.toggleSelectRow(x)}}else{if(e(s.target).closest(".blist-column-adder-icon").length>0){w.preventDefault();t.settings.addColumnCallback(v.id)}}};var g=function(s,u,t){if(_.isFunction(s.settings.cellCommentsCallback)){s.settings.cellCommentsCallback(u,t)}};var m=function(s,t){_.each(t,function(v){var u=e(v.row);if(!u.is(".blist-tr-open")){return true}u.find(".blist-tdh[colId]").each(function(y,z){var B=e(z);if(B.hasClass("setup")){return true}var w=B.attr("parentColId");var C=s._view.columnForID(w);if(!e.isBlank(C)){var A=B.attr("colId");var x=C.childColumnForID(A);if(!e.isBlank(x)){a(s,x,B,false)}}})})};var a=function(x,s,z,w){var v=z.hasClass("blist-tdh");var u=z.find(".menuLink");z.columnMenu({column:s,$menuTrigger:u,columnDeleteEnabled:x.settings.columnDeleteEnabled,columnHideEnabled:x.settings.columnHideEnabled,columnPropertiesEnabled:x.settings.columnPropertiesEnabled,editColumnCallback:x.settings.editColumnCallback,selectedColumns:function(){return e(x.currentGrid).blistTableAccessor().getSelectedColumns()},view:x._view});var y=z.find(".menuLink").socrataTip({message:e.t("controls.grid.menu"),parent:"body",shrinkToFit:true,trigger:"hover",isSolo:false});u.click(function(){y.hide()});z.addClass("setup");var B=z.find(".info-button");var t=z.find(".button-wrapper");if(s.renderType.sortable&&!v){z.find(".blist-th-name").socrataTip({trigger:"hover",message:e.t("controls.grid.click_to_sort"),parent:"body",isSolo:true})}if(w||v){var A=blist.datasetControls.getColumnTip(s);t.socrataTip({content:A,trigger:"mouseenter click",parent:"body",isSolo:true,shownCallback:function(){e(t.socrataTip()._tipBox).mouseleave(function(){e(t.socrataTip().hide())})}})}t.click(function(){B.socrataTip().quickHide()})};var p=function(s,t){if(!s.settings._colTips){s.settings._colTips={}}a(s,t,e(t.dom),s.settings._colTips)};var b=function(s,u,t){e(u.dom).columnMenu().sort(t)};var j=function(s,t){e(t.dom).columnMenu().clearFilter()};var q=function(s,u,v){var w=_.pluck(s._view.visibleColumns,"id");var t=_.indexOf(w,u.id);w.splice(v,0,u.id);w.splice((v<t?t+1:t),1);s._view.setVisibleColumns(w,null,s._view.temporary)};var k=function(u,x,t){if(!u.settings.columnNameEdit||u._view.temporary){return}var s=e(t.currentTarget).find(".blist-th-name");var w=s.closest(".blist-th").addClass("editable");var y=s.closest(".name-wrapper");var v=y.find("form");if(v.length<1){y.append('<form class="action-item"><input type="text" /></form>');v=y.find("form");v.submit(function(z){d(u,z)}).find(":input").keydown(function(z){l(u,z)})}v.find(":input").removeAttr("disabled").val(s.text()).focus().select();e(document).bind("mousedown.columnNameEdit-"+w.data("column").id,function(z){c(u,z,w)}).bind("mouseup.columnNameEdit-"+w.data("column").id,function(z){c(u,z,w)})};var r=function(s,t){s.$dom().focus();t.removeClass("editable error");e(document).unbind(".columnNameEdit-"+t.data("column").id)};var f=function(s,w){var x=w.find(":input");var t=x.val();if(t===""){alert(e.t("controls.grid.must_enter_name"));w.addClass("error");return}var v=w.find(".blist-th-name").text();if(v==t){r(s,w);return}var u=s._view.columnForID(w.data("column").id);u.update({name:t});x.attr("disabled","disabled");u.save(function(y){r(s,w)},function(z){var y=JSON.parse(z.responseText);alert(y.message);w.addClass("error");x.removeAttr("disabled")})};var c=function(t,v,u){var s=e(v.target);if((s.is(".name-wrapper :input")&&s.parents().index(u)>=0)||s.closest("#jqmAlert").length>0){return}f(t,u)};var d=function(s,t){t.preventDefault();f(s,e(t.target).closest(".blist-th"))};var l=function(s,t){if(t.keyCode==27){r(s,e(t.target).closest(".blist-th"))}}})(jQuery);